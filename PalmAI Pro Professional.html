<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PalmAI Pro Professional - Ïû¨ÎØ∏Î°ú Î≥¥Îäî ÏÜêÍ∏à Î∂ÑÏÑù ÏãúÏä§ÌÖú</title>
  <style>
    /* ===== CSS Variables & Base Styles ===== */
    :root {
      --primary: #6a11cb;
      --secondary: #2575fc;
      --success: #00b894;
      --danger: #d63031;
      --warning: #fdcb6e;
      --info: #74b9ff;
      --dark: #2d3436;
      --light: #f5f6fa;
      --text: #2c3e50;
      --border: #dfe6e9;
      --shadow: 0 5px 20px rgba(0,0,0,.1);
      --transition: all .3s cubic-bezier(.4,0,.2,1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      min-height: 100vh;
      color: var(--text);
      line-height: 1.6;
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .app-header {
      color: #fff;
      text-align: center;
      padding: 40px 20px;
    }

    .app-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 6px rgba(0,0,0,.25);
    }

    .app-header p {
      font-size: 1.1rem;
      opacity: .95;
    }

    /* ===== Step Navigation ===== */
    .step-navigation {
      background: #fff;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
    }

    .steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 20px;
    }

    .steps:before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 22px;
      height: 2px;
      background: var(--border);
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      z-index: 1;
    }

    .step-number {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      background: var(--light);
      border: 2px solid var(--border);
      transition: var(--transition);
    }

    .step.active .step-number {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      transform: scale(1.1);
    }

    .step.completed .step-number {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
    }

    .step-label {
      font-size: .9rem;
      font-weight: 500;
    }

    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      width: 20%;
      transition: width .5s;
    }

    /* ===== Content Area ===== */
    .content-area {
      background: #fff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      min-height: 600px;
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: fadeIn .3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Upload Section ===== */
    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .upload-card {
      border: 3px dashed var(--border);
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      position: relative;
      background: var(--light);
      transition: var(--transition);
      cursor: pointer;
    }

    .upload-card:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: var(--shadow);
    }

    .upload-card.has-image {
      border-style: solid;
      border-color: var(--success);
      background: #fff;
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-preview {
      position: absolute;
      inset: 3px;
      width: calc(100% - 6px);
      height: calc(100% - 6px);
      object-fit: cover;
      border-radius: 13px;
      opacity: 0;
      transition: opacity .3s;
      pointer-events: none;
    }

    .upload-preview.visible {
      opacity: 1;
    }

    .quality-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: .85rem;
      font-weight: 700;
      color: #fff;
      z-index: 2;
    }

    .quality-high { background: var(--success); }
    .quality-medium { background: var(--warning); }
    .quality-low { background: var(--danger); }

    /* ===== Form Styles ===== */
    .saju-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-control {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color .2s;
    }

    .form-control:focus {
      outline: 0;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(106,17,203,.1);
    }

    .form-control.invalid {
      border-color: var(--danger);
      background: #fff5f5;
    }

    .hint {
      font-size: .8rem;
      color: #6b7280;
    }

    /* ===== Analysis Preview Canvas ===== */
    #palm-canvas {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      border: 2px solid var(--border);
      border-radius: 10px;
      display: block;
      background: #f8f9fa;
    }

    /* ===== Analysis Progress ===== */
    .analysis-progress {
      margin: 30px 0;
    }

    .analysis-step {
      padding: 16px 20px;
      margin: 12px 0;
      background: var(--light);
      border-left: 4px solid var(--primary);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all .3s;
    }

    .analysis-step.complete {
      background: #e6f7e6;
      border-left-color: var(--success);
    }

    .progress-percentage {
      font-weight: 800;
      color: var(--primary);
      font-size: 1.1rem;
    }

    /* ===== Result Cards ===== */
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      margin: 25px 0;
    }

    .result-card {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      padding: 25px 20px;
      border-radius: 16px;
      text-align: center;
      transition: all .3s;
      position: relative;
      overflow: hidden;
    }

    .result-card.clickable {
      cursor: pointer;
    }

    .result-card.clickable:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(106,17,203,.3);
    }

    .result-card.clickable:hover::after {
      content: 'üìä ÏÉÅÏÑ∏Î≥¥Í∏∞';
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: .8rem;
      opacity: .9;
    }

    .result-score {
      font-size: 2.5rem;
      font-weight: 900;
      margin-bottom: 8px;
    }

    .result-label {
      font-size: 1rem;
      opacity: .95;
    }

    /* ===== Expert Analysis Panel ===== */
    .expert-panel {
      background: #fff;
      border-left: 5px solid var(--primary);
      border-radius: 12px;
      padding: 25px;
      margin: 25px 0;
      box-shadow: var(--shadow);
    }

    .expert-panel h3 {
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .line-analysis {
      margin: 20px 0;
      padding: 15px;
      background: var(--light);
      border-radius: 10px;
    }

    .line-analysis h4 {
      color: var(--dark);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .line-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--primary);
      color: #fff;
    }

    .feature-list {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }

    .feature-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .feature-label {
      font-weight: 500;
      color: var(--text);
    }

    .feature-value {
      color: var(--primary);
      font-weight: 600;
    }

    /* ===== Interpretation Section ===== */
    .interpretation-section {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      border-radius: 15px;
      padding: 30px;
      margin: 25px 0;
    }

    .interpretation-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .interpretation-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .interpretation-card h4 {
      margin-bottom: 12px;
      font-size: 1.1rem;
    }

    .interpretation-card p {
      font-size: 0.95rem;
      line-height: 1.6;
      opacity: 0.95;
    }

    /* ===== Buttons ===== */
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all .2s;
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(106,17,203,.3);
    }

    .btn-secondary {
      background: #fff;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 25px;
    }

    /* ===== Banners ===== */
    .banner {
      padding: 14px 18px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: .95rem;
    }

    .banner.info {
      background: #eef7ff;
      border-left: 4px solid #3b82f6;
    }

    .banner.warn {
      background: #fff7e6;
      border-left: 4px solid #f59e0b;
    }

    .banner.error {
      background: #ffecec;
      border-left: 4px solid #ef4444;
    }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 20px;
      max-width: 800px;
      width: 92%;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.3);
      animation: modalSlide .3s ease;
    }

    @keyframes modalSlide {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      padding: 25px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,.2);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.3rem;
      transition: .2s;
    }

    .modal-close:hover {
      background: rgba(255,255,255,.3);
    }

    .modal-body {
      padding: 30px;
      overflow-y: auto;
      max-height: 60vh;
    }

    /* ===== Loading ===== */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ddd;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .app-header h1 { font-size: 2rem; }
      .upload-grid { grid-template-columns: 1fr; }
      .result-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
      .interpretation-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <h1>üñêÔ∏è PalmAI Pro Professional</h1>
    <p>Í∞ÄÎÅî Ïò§Î•òÍ∞Ä ÎÇ† ÏàòÎèÑ ÏûàÎäî ÏÜêÍ∏à Î∂ÑÏÑùÍ∏∞ ^^ ¬∑ Ïû¨ÎØ∏Î°ú Î¥ê Ï£ºÏÑ∏Ïöî~~</p>
  </header>

  <main class="main-container">
    <!-- Step Navigation -->
    <nav class="step-navigation">
      <div class="steps">
        <div class="step active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-label">Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-label">Ï†ÑÏ≤òÎ¶¨</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-label">ÏÇ¨Ï£º ÏûÖÎ†•</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-label">AI Î∂ÑÏÑù</div>
        </div>
        <div class="step" data-step="5">
          <div class="step-number">5</div>
          <div class="step-label">Ï†ÑÎ¨∏Í∞Ä Î¶¨Ìè¨Ìä∏</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </nav>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Step 1: Upload -->
      <section class="step-content active" id="step1">
        <h2>Í≥†ÌôîÏßà ÏÜêÎ∞îÎã• Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</h2>
        <div class="banner info">
          <strong>üì∏ Ï¥¨ÏòÅ Í∞ÄÏù¥Îìú:</strong> Î∞ùÏùÄ ÏûêÏó∞Í¥ëÏóêÏÑú ÏÜêÎ∞îÎã•ÏùÑ ÏôÑÏ†ÑÌûà Ìé¥Í≥†, ÏÜêÍ∏àÏÑ†Ïù¥ Î™ÖÌôïÌûà Î≥¥Ïù¥ÎèÑÎ°ù Ï¥¨ÏòÅÌïòÏÑ∏Ïöî.
          ÏµúÏÜå 2048x2048 ÌîΩÏÖÄ Ïù¥ÏÉÅÏùò Í≥†ÌôîÏßà Ïù¥ÎØ∏ÏßÄÎ•º Í∂åÏû•Ìï©ÎãàÎã§.
        </div>

        <div class="upload-grid">
          <!-- Left Hand -->
          <label for="left-hand-input" class="upload-card">
            <input type="file" id="left-hand-input" accept="image/*" style="display:none"/>
            <div class="upload-icon">ü§ö</div>
            <h3>ÏôºÏÜê (ÏÑ†Ï≤úÏ†Å ÌäπÏÑ±)</h3>
            <p>Ïû†Ïû¨Î†•, ÌÉÄÍ≥†ÎÇú ÏÑ±Ìñ• Î∂ÑÏÑù</p>
            <img class="upload-preview" id="left-preview" alt="ÏôºÏÜê ÎØ∏Î¶¨Î≥¥Í∏∞"/>
            <div class="quality-badge" id="left-quality"></div>
          </label>

          <!-- Right Hand -->
          <label for="right-hand-input" class="upload-card">
            <input type="file" id="right-hand-input" accept="image/*" style="display:none"/>
            <div class="upload-icon">üñêÔ∏è</div>
            <h3>Ïò§Î•∏ÏÜê (ÌõÑÏ≤úÏ†Å Î∞úÌòÑ)</h3>
            <p>ÌòÑÏû¨ ÏÉÅÌÉú, ÎÖ∏Î†•Ïùò Í≤∞Í≥º Î∂ÑÏÑù</p>
            <img class="upload-preview" id="right-preview" alt="Ïò§Î•∏ÏÜê ÎØ∏Î¶¨Î≥¥Í∏∞"/>
            <div class="quality-badge" id="right-quality"></div>
          </label>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="nextStep()">Îã§Ïùå Îã®Í≥Ñ: Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨</button>
        </div>
      </section>

      <!-- Step 2: Preprocessing -->
      <section class="step-content" id="step2">
        <h2>Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨ Î∞è ÌíàÏßà Í≤ÄÏ¶ù</h2>
        <canvas id="palm-canvas" width="800" height="600"></canvas>
        
        <div class="expert-panel">
          <h3>üîç Ï†ÑÏ≤òÎ¶¨ ÏÉÅÌÉú</h3>
          <ul class="feature-list">
            <li>
              <span class="feature-label">Ïù¥ÎØ∏ÏßÄ Ìï¥ÏÉÅÎèÑ</span>
              <span class="feature-value" id="resolution-value">Î∂ÑÏÑù Ï§ë...</span>
            </li>
            <li>
              <span class="feature-label">Î™ÖÏïî ÎåÄÎπÑ</span>
              <span class="feature-value" id="contrast-value">Î∂ÑÏÑù Ï§ë...</span>
            </li>
            <li>
              <span class="feature-label">ÏÑ†Î™ÖÎèÑ</span>
              <span class="feature-value" id="sharpness-value">Î∂ÑÏÑù Ï§ë...</span>
            </li>
            <li>
              <span class="feature-label">ÎÖ∏Ïù¥Ï¶à ÏàòÏ§Ä</span>
              <span class="feature-value" id="noise-value">Î∂ÑÏÑù Ï§ë...</span>
            </li>
          </ul>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previousStep()">Ïù¥Ï†Ñ</button>
          <button class="btn btn-primary" onclick="nextStep()">Îã§Ïùå Îã®Í≥Ñ: ÏÇ¨Ï£º Ï†ïÎ≥¥</button>
        </div>
      </section>

      <!-- Step 3: Saju Input -->
      <section class="step-content" id="step3">
        <h2>ÏÇ¨Ï£º Ï†ïÎ≥¥ ÏûÖÎ†• (ÏÑ†ÌÉùÏÇ¨Ìï≠)</h2>
        <div class="banner info">
          <strong>üåü Ï†ïÌôïÎèÑ Ìñ•ÏÉÅ:</strong> ÏÇ¨Ï£º Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÎ©¥ ÏÜêÍ∏à Î∂ÑÏÑùÍ≥º ÌÜµÌï©ÌïòÏó¨ ÎçîÏö± Ï†ïÎ∞ÄÌïú Ìï¥ÏÑùÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.
        </div>

        <form class="saju-form" id="saju-form" novalidate>
          <div class="form-group">
            <label for="birth-year">ÏÉùÎÖÑ</label>
            <input type="number" class="form-control" id="birth-year" 
                   placeholder="Ïòà: 1991" min="1900" max="2100"/>
            <div class="hint">ÏñëÎ†• Í∏∞Ï§Ä</div>
          </div>
          <div class="form-group">
            <label for="birth-month">ÏÉùÏõî</label>
            <input type="number" class="form-control" id="birth-month" 
                   placeholder="1-12" min="1" max="12"/>
          </div>
          <div class="form-group">
            <label for="birth-day">ÏÉùÏùº</label>
            <input type="number" class="form-control" id="birth-day" 
                   placeholder="1-31" min="1" max="31"/>
          </div>
          <div class="form-group">
            <label for="birth-hour">ÏÉùÏãú</label>
            <input type="number" class="form-control" id="birth-hour" 
                   placeholder="0-23" min="0" max="23"/>
            <div class="hint">24ÏãúÍ∞Ñ ÌòïÏãù</div>
          </div>
          <div class="form-group">
            <label for="gender">ÏÑ±Î≥Ñ</label>
            <select class="form-control" id="gender">
              <option value="">ÏÑ†ÌÉù</option>
              <option value="male">ÎÇ®ÏÑ±</option>
              <option value="female">Ïó¨ÏÑ±</option>
            </select>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="lunar-calendar"/> ÏùåÎ†•
            </label>
          </div>
        </form>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previousStep()">Ïù¥Ï†Ñ</button>
          <button class="btn btn-primary" onclick="nextStep()">Îã§Ïùå Îã®Í≥Ñ: AI Î∂ÑÏÑù ÏãúÏûë</button>
        </div>
      </section>

      <!-- Step 4: Analysis -->
      <section class="step-content" id="step4">
        <h2>Îî•Îü¨Îãù Í∏∞Î∞ò Ï†ÑÎ¨∏Í∞Ä Î∂ÑÏÑù ÏßÑÌñâ</h2>
        <div class="analysis-progress">
          <div class="analysis-step" id="preprocessing">
            <span>üì∏ Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨ (ÎÖ∏Ïù¥Ï¶à Ï†úÍ±∞, ÏÉâÏÉÅ Î≥¥Ï†ï)</span>
            <span class="progress-percentage">0%</span>
          </div>
          <div class="analysis-step" id="segmentation">
            <span>üîç CNN Í∏∞Î∞ò ÏÜêÍ∏àÏÑ† ÏÑ∏Í∑∏Î©òÌÖåÏù¥ÏÖò</span>
            <span class="progress-percentage">0%</span>
          </div>
          <div class="analysis-step" id="feature-extraction">
            <span>üìä Ï£ºÏÑ†/Î≥¥Ï°∞ÏÑ† ÌäπÏßï Ï∂îÏ∂ú (Í∏∏Ïù¥, ÍπäÏù¥, Î∂ÑÍ∏∞)</span>
            <span class="progress-percentage">0%</span>
          </div>
          <div class="analysis-step" id="pattern-matching">
            <span>üß¨ Ï†ÑÎ¨∏Í∞Ä DB Ìå®ÌÑ¥ Îß§Ïπ≠</span>
            <span class="progress-percentage">0%</span>
          </div>
          <div class="analysis-step" id="report-generation">
            <span>üìù Ï¢ÖÌï© Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±</span>
            <span class="progress-percentage">0%</span>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previousStep()">Ïù¥Ï†Ñ</button>
          <button class="btn btn-primary" onclick="startProfessionalAnalysis()">Ï†ÑÎ¨∏Í∞Ä Î∂ÑÏÑù ÏãúÏûë</button>
        </div>
      </section>

      <!-- Step 5: Professional Report -->
      <section class="step-content" id="step5">
        <h2>Ï†ÑÎ¨∏Í∞Ä ÏàòÏ§Ä Ï¢ÖÌï© Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏</h2>
        
        <div id="global-banners"></div>

        <!-- Score Overview -->
        <div class="result-grid" id="result-grid"></div>

        <!-- Main Lines Analysis -->
        <div class="expert-panel">
          <h3>üìã Ï£ºÏöî ÏÜêÍ∏àÏÑ† ÏÉÅÏÑ∏ Î∂ÑÏÑù</h3>
          <div id="main-lines-analysis"></div>
        </div>

        <!-- Auxiliary Lines Analysis -->
        <div class="expert-panel">
          <h3>üìê Î≥¥Ï°∞ÏÑ† Î∞è ÌäπÏàò Î¨∏Ïñë Î∂ÑÏÑù</h3>
          <div id="auxiliary-lines-analysis"></div>
        </div>

        <!-- Professional Interpretation -->
        <div class="interpretation-section">
          <h3>üéØ Ï†ÑÎ¨∏Í∞Ä Ï¢ÖÌï© Ìï¥ÏÑù</h3>
          <div class="interpretation-grid" id="interpretation-grid"></div>
        </div>

        <!-- Life Phase Analysis -->
        <div class="expert-panel">
          <h3>üìÖ ÏÉùÏï† Ï£ºÍ∏∞Î≥Ñ ÏòàÏ∏°</h3>
          <div id="life-phase-analysis"></div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="exportProfessionalReport()">üìä Ï†ÑÎ¨∏ Î¶¨Ìè¨Ìä∏ Îã§Ïö¥Î°úÎìú</button>
          <button class="btn btn-danger" onclick="resetAnalysis()">üîÑ ÏÉà Î∂ÑÏÑù ÏãúÏûë</button>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">ÏÉÅÏÑ∏ Î∂ÑÏÑù</h2>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <script>
    'use strict';

    // ===== Professional Palm Reading Database =====
    const PALM_LINES_DB = {
      // Ï£ºÏÑ† (Major Lines)
      lifeLine: {
        name: 'ÏÉùÎ™ÖÏÑ†',
        aspects: ['length', 'depth', 'curve', 'breaks', 'branches', 'islands'],
        interpretation: {
          long: 'Í∞ïÏù∏Ìïú ÏÉùÎ™ÖÎ†•Í≥º ÌôúÎ†•, Ïû•ÏàòÏùò Í∞ÄÎä•ÏÑ±',
          deep: 'Í±¥Í∞ïÌïòÍ≥† ÏïàÏ†ïÏ†ÅÏù∏ Ï≤¥Ïßà',
          curved: 'Îî∞ÎúªÌïòÍ≥† Í¥ÄÎåÄÌïú ÏÑ±Í≤©',
          straight: 'Ïã†Ï§ëÌïòÍ≥† Ï°∞Ïã¨Ïä§Îü¨Ïö¥ ÏÑ±Ìñ•',
          broken: 'Ïù∏ÏÉùÏùò Ï†ÑÌôòÏ†êÏù¥ÎÇò Í±¥Í∞ïÏÉÅ Ï£ºÏùò ÏãúÍ∏∞',
          island: 'ÏùºÏãúÏ†Å Í±¥Í∞ï Î¨∏Ï†úÎÇò Ïä§Ìä∏Î†àÏä§ ÏãúÍ∏∞',
          branches_up: 'Í∏çÏ†ïÏ†Å ÏóêÎÑàÏßÄÏôÄ ÏÑ±Ïû•',
          branches_down: 'ÏóêÎÑàÏßÄ ÏÜåÎ™®ÎÇò ÌîºÎ°ú ÏãúÍ∏∞'
        }
      },
      headLine: {
        name: 'ÎëêÎáåÏÑ†',
        aspects: ['length', 'slope', 'clarity', 'fork', 'islands', 'dots'],
        interpretation: {
          long: 'ÍπäÏùÄ ÏÇ¨Í≥†Î†•Í≥º ÏßëÏ§ëÎ†•',
          short: 'Ïã§Ïö©Ï†ÅÏù¥Í≥† ÏßÅÏÑ†Ï†ÅÏù∏ ÏÇ¨Í≥†',
          straight: 'ÎÖºÎ¶¨Ï†ÅÏù¥Í≥† Î∂ÑÏÑùÏ†ÅÏù∏ ÏÇ¨Í≥†',
          curved: 'Ï∞ΩÏùòÏ†ÅÏù¥Í≥† ÏÉÅÏÉÅÎ†•Ïù¥ ÌíçÎ∂Ä',
          forked: 'Îã§Ïû¨Îã§Îä•Ìïú ÏßÄÏ†Å Îä•Î†•',
          clear: 'Î™ÖÌôïÌïú ÌåêÎã®Î†•Í≥º Í≤∞Îã®Î†•',
          wavy: 'Î≥ÄÌôîÎ¨¥ÏåçÌïú ÏÇ¨Í≥† Ìå®ÌÑ¥'
        }
      },
      heartLine: {
        name: 'Í∞êÏ†ïÏÑ†',
        aspects: ['length', 'curve', 'branches', 'chains', 'depth'],
        interpretation: {
          long: 'ÍπäÍ≥† ÏßÄÏÜçÏ†ÅÏù∏ Í∞êÏ†ï ÌëúÌòÑ',
          curved: 'Ïó¥Ï†ïÏ†ÅÏù¥Í≥† ÌëúÌòÑÎ†•Ïù¥ ÌíçÎ∂Ä',
          straight: 'Ïù¥ÏÑ±Ï†ÅÏù¥Í≥† Ï†àÏ†úÎêú Í∞êÏ†ï ÌëúÌòÑ',
          branched: 'Îã§ÏñëÌïú Í∞êÏ†ïÏ†Å Í≤ΩÌóò',
          chained: 'Í∞êÏ†ïÏ†Å ÌòºÎûÄÏù¥ÎÇò Î≥µÏû°Ìïú Í¥ÄÍ≥Ñ',
          deep: 'Í∞ïÎ†¨Ìïú Í∞êÏ†ïÍ≥º ÍπäÏùÄ Ïï†Ï†ï'
        }
      },
      fateLine: {
        name: 'Ïö¥Î™ÖÏÑ†',
        aspects: ['presence', 'length', 'direction', 'breaks', 'strength'],
        interpretation: {
          strong: 'Î™ÖÌôïÌïú Ïù∏ÏÉù Î™©ÌëúÏôÄ Í∞ïÌïú ÏùòÏßÄ',
          weak: 'Ïú†Ïó∞Ìïú Ïù∏ÏÉù Í≤ΩÎ°ú',
          absent: 'ÏûêÏú†Î°úÏö¥ ÏòÅÌòº, ÎèÖÎ¶ΩÏ†Å ÏÑ±Ìñ•',
          broken: 'Í≤ΩÎ†• Î≥ÄÌôîÎÇò Ï†ÑÌôòÏ†ê',
          double: 'Îã§Ï§ë Í≤ΩÎ†•Ïù¥ÎÇò Î∂ÄÏóÖ Í∞ÄÎä•ÏÑ±'
        }
      },
      
      // Î≥¥Ï°∞ÏÑ† (Minor Lines)
      sunLine: {
        name: 'ÌÉúÏñëÏÑ†',
        aspects: ['presence', 'length', 'clarity'],
        interpretation: {
          present: 'ÏÑ±Í≥µÍ≥º Î™ÖÏòà, Ï∞ΩÏùòÏ†Å Ïû¨Îä•',
          long: 'ÏßÄÏÜçÏ†ÅÏù∏ ÏÑ±Í≥µÍ≥º Ïù∏Ï†ï',
          multiple: 'Îã§Î∞©Î©¥Ïùò Ïû¨Îä•Í≥º ÏÑ±Í≥µ Í∞ÄÎä•ÏÑ±'
        }
      },
      mercuryLine: {
        name: 'ÏàòÏÑ±ÏÑ† (Í±¥Í∞ïÏÑ†)',
        aspects: ['presence', 'clarity', 'breaks'],
        interpretation: {
          absent: 'Í±¥Í∞ïÌïú Ï≤¥Ïßà (ÏóÜÎäî Í≤ÉÏù¥ Ï¢ãÏùå)',
          clear: 'ÏÇ¨ÏóÖ ÏàòÏôÑÍ≥º Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò Îä•Î†•',
          wavy: 'ÏÜåÌôîÍ∏∞ Í≥ÑÌÜµ Ï£ºÏùò ÌïÑÏöî'
        }
      },
      marriageLines: {
        name: 'Í≤∞ÌòºÏÑ†',
        aspects: ['count', 'length', 'depth', 'fork'],
        interpretation: {
          single_deep: 'Ìïú Î≤àÏùò ÍπäÏùÄ Ïù∏Ïó∞',
          multiple: 'Ïó¨Îü¨ Î≤àÏùò Ï§ëÏöîÌïú Í¥ÄÍ≥Ñ',
          forked: 'Í¥ÄÍ≥ÑÏùò Î≥ÄÌôîÎÇò ÎèÑÏ†Ñ',
          curved_up: 'ÌñâÎ≥µÌïú Í¥ÄÍ≥Ñ',
          curved_down: 'Í¥ÄÍ≥ÑÏùò Ïñ¥Î†§ÏõÄ'
        }
      },
      childrenLines: {
        name: 'ÏûêÎÖÄÏÑ†',
        aspects: ['count', 'depth'],
        interpretation: {
          deep: 'Í±¥Í∞ïÌïú ÏûêÎÖÄ',
          faint: 'ÏûêÎÖÄÏôÄÏùò Ïó∞Ïù¥ ÏïΩÌï®',
          multiple: 'Ïó¨Îü¨ ÏûêÎÖÄ Í∞ÄÎä•ÏÑ±'
        }
      },
      intuitionLine: {
        name: 'ÏßÅÍ¥ÄÏÑ†',
        aspects: ['presence', 'clarity'],
        interpretation: {
          present: 'Í∞ïÌïú ÏßÅÍ¥ÄÎ†•Í≥º ÏòÅÏ†Å Í∞êÍ∞Å',
          clear: 'Îõ∞Ïñ¥ÎÇú ÌÜµÏ∞∞Î†•'
        }
      },
      
      // ÌäπÏàò Î¨∏Ïñë (Special Marks)
      specialMarks: {
        star: {
          name: 'Î≥Ñ',
          interpretation: 'ÌäπÎ≥ÑÌïú Ïû¨Îä•Ïù¥ÎÇò ÌñâÏö¥Ïùò ÏãúÍ∏∞'
        },
        cross: {
          name: 'Ïã≠Ïûê',
          interpretation: 'ÎèÑÏ†ÑÏù¥ÎÇò ÏãúÎ†®, ÎïåÎ°úÎäî Î≥¥Ìò∏Ïùò ÌëúÏãú'
        },
        square: {
          name: 'ÏÇ¨Í∞ÅÌòï',
          interpretation: 'Î≥¥Ìò∏ÏôÄ ÏïàÏ†ïÏùò ÌëúÏãú'
        },
        triangle: {
          name: 'ÏÇºÍ∞ÅÌòï',
          interpretation: 'ÏßÄÏ†Å Îä•Î†•Í≥º ÏÑ±Í≥µ'
        },
        grille: {
          name: 'Í≤©Ïûê',
          interpretation: 'ÏóêÎÑàÏßÄ Î∂ÑÏÇ∞Ïù¥ÎÇò ÌòºÎûÄ'
        },
        island: {
          name: 'ÏÑ¨',
          interpretation: 'ÏùºÏãúÏ†Å Ïñ¥Î†§ÏõÄÏù¥ÎÇò Ïû•Ïï†'
        },
        dot: {
          name: 'Ï†ê',
          interpretation: 'ÏùºÏãúÏ†Å Î¨∏Ï†úÎÇò Ï£ºÏùòÏ†ê'
        }
      }
    };

    // ===== Mount Areas Database =====
    const MOUNT_AREAS = {
      jupiter: {
        name: 'Î™©ÏÑ±Íµ¨',
        location: 'Í≤ÄÏßÄ ÏïÑÎûò',
        traits: 'Î¶¨ÎçîÏã≠, ÏïºÎßù, ÏûêÏã†Í∞ê',
        interpretation: {
          developed: 'Í∞ïÌïú Î¶¨ÎçîÏã≠Í≥º ÏïºÎßù',
          flat: 'Í≤∏ÏÜêÌïòÍ≥† ÌòëÏ°∞Ï†Å',
          overdeveloped: 'Í≥ºÎèÑÌïú ÏûêÎßåÏã¨ Ï£ºÏùò'
        }
      },
      saturn: {
        name: 'ÌÜ†ÏÑ±Íµ¨',
        location: 'Ï§ëÏßÄ ÏïÑÎûò',
        traits: 'Ï±ÖÏûÑÍ∞ê, ÏßÑÏßÄÌï®, Ïó∞Íµ¨Ïã¨',
        interpretation: {
          developed: 'Ïã†Ï§ëÌïòÍ≥† Ï±ÖÏûÑÍ∞ê ÏûàÏùå',
          flat: 'Í≤ΩÏÜîÌï† Ïàò ÏûàÏùå',
          overdeveloped: 'Ïö∞Ïö∏ÌïòÍ±∞ÎÇò ÎπÑÍ¥ÄÏ†Å ÏÑ±Ìñ•'
        }
      },
      sun: {
        name: 'ÌÉúÏñëÍµ¨',
        location: 'ÏïΩÏßÄ ÏïÑÎûò',
        traits: 'Ï∞ΩÏùòÏÑ±, ÏòàÏà†ÏÑ±, Î™ÖÏòà',
        interpretation: {
          developed: 'ÏòàÏà†Ï†Å Ïû¨Îä•Í≥º Ï∞ΩÏùòÏÑ±',
          flat: 'ÏòàÏà†Ï†Å Í¥ÄÏã¨ Î∂ÄÏ°±',
          overdeveloped: 'ÌóàÏòÅÏã¨ Ï£ºÏùò'
        }
      },
      mercury: {
        name: 'ÏàòÏÑ±Íµ¨',
        location: 'ÏÉàÎÅºÏÜêÍ∞ÄÎùΩ ÏïÑÎûò',
        traits: 'Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò, ÏÇ¨ÏóÖ ÏàòÏôÑ',
        interpretation: {
          developed: 'Îõ∞Ïñ¥ÎÇú ÏÜåÌÜµ Îä•Î†•',
          flat: 'ÏÜåÌÜµÏóê Ïñ¥Î†§ÏõÄ',
          overdeveloped: 'Í≥ºÎèÑÌïú ÎßêÏàò'
        }
      },
      mars_positive: {
        name: 'Ïñë ÌôîÏÑ±Íµ¨',
        location: 'ÏÉùÎ™ÖÏÑ† ÏãúÏûë Î∂ÄÎ∂Ñ',
        traits: 'Ïö©Í∏∞, ÌôúÎ†•, ÎèÑÏ†ÑÏ†ïÏã†'
      },
      mars_negative: {
        name: 'Ïùå ÌôîÏÑ±Íµ¨',
        location: 'ÏÜêÎ∞îÎã• Ïô∏Ï∏° Ï§ëÍ∞Ñ',
        traits: 'Ïù∏ÎÇ¥, Ï†ÄÌï≠Î†•'
      },
      venus: {
        name: 'Í∏àÏÑ±Íµ¨',
        location: 'ÏóÑÏßÄ ÏïÑÎûò',
        traits: 'ÏÇ¨Îûë, ÎØ∏Ï†Å Í∞êÍ∞Å, Í∞êÏÑ±',
        interpretation: {
          developed: 'Îî∞ÎúªÌïòÍ≥† Ïï†Ï†ïÏù¥ ÌíçÎ∂Ä',
          flat: 'Í∞êÏ†ï ÌëúÌòÑÏóê ÏÑúÌàº',
          overdeveloped: 'Í≥ºÎèÑÌïú ÏöïÍµ¨'
        }
      },
      luna: {
        name: 'ÏõîÍµ¨',
        location: 'ÏÜêÎ∞îÎã• ÌïòÎã® Ïô∏Ï∏°',
        traits: 'ÏÉÅÏÉÅÎ†•, ÏßÅÍ¥Ä, Ï∞ΩÏùòÏÑ±',
        interpretation: {
          developed: 'ÌíçÎ∂ÄÌïú ÏÉÅÏÉÅÎ†•',
          flat: 'ÌòÑÏã§Ï†Å ÏÑ±Ìñ•',
          overdeveloped: 'Í≥ºÎèÑÌïú ÌôòÏÉÅ'
        }
      }
    };

    // ===== Application State =====
    const AppState = {
      currentStep: 1,
      palmImages: {
        left: null,
        right: null,
        quality: { left: null, right: null }
      },
      preprocessedData: {
        left: null,
        right: null
      },
      sajuData: {
        year: null,
        month: null,
        day: null,
        hour: null,
        gender: null,
        isLunar: false
      },
      analysisResults: null,
      extractedFeatures: {
        left: null,
        right: null
      }
    };

    // ===== Image Processing Functions =====
    
    /**
     * Advanced image quality evaluation using multiple metrics
     */
    async function evaluateImageQuality(dataUrl) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = canvas.height = 512;
          ctx.drawImage(img, 0, 0, 512, 512);
          
          const imageData = ctx.getImageData(0, 0, 512, 512);
          const data = imageData.data;
          
          // Calculate multiple quality metrics
          let brightness = 0, contrast = 0, sharpness = 0;
          let min = 255, max = 0;
          let edges = 0;
          
          for (let i = 0; i < data.length; i += 4) {
            const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
            brightness += gray;
            min = Math.min(min, gray);
            max = Math.max(max, gray);
            
            // Simple edge detection for sharpness
            if (i > 512 * 4) {
              const diff = Math.abs(gray - (0.299 * data[i-512*4] + 0.587 * data[i-512*4+1] + 0.114 * data[i-512*4+2]));
              if (diff > 30) edges++;
            }
          }
          
          brightness = brightness / (512 * 512);
          contrast = (max - min) / 255;
          sharpness = edges / (512 * 512) * 100;
          
          // Calculate overall quality score
          const brightnessScore = Math.abs(brightness - 128) < 50 ? 35 : 15;
          const contrastScore = contrast > 0.4 ? 35 : 20;
          const sharpnessScore = sharpness > 5 ? 30 : 15;
          
          const overallScore = Math.round(brightnessScore + contrastScore + sharpnessScore);
          
          resolve({
            score: Math.max(30, Math.min(95, overallScore)),
            brightness: Math.round(brightness),
            contrast: Math.round(contrast * 100),
            sharpness: Math.round(sharpness),
            resolution: `${img.width}x${img.height}`
          });
        };
        img.src = dataUrl;
      });
    }

    /**
     * Image preprocessing - noise reduction, contrast enhancement
     */
    async function preprocessImage(dataUrl) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.getElementById('palm-canvas');
          const ctx = canvas.getContext('2d');
          
          // Resize to standard dimensions
          canvas.width = 800;
          canvas.height = 600;
          ctx.drawImage(img, 0, 0, 800, 600);
          
          // Apply contrast enhancement
          const imageData = ctx.getImageData(0, 0, 800, 600);
          const data = imageData.data;
          
          // Histogram equalization for better contrast
          const histogram = new Array(256).fill(0);
          for (let i = 0; i < data.length; i += 4) {
            const gray = Math.round(0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2]);
            histogram[gray]++;
          }
          
          // Cumulative distribution
          const cdf = histogram.slice();
          for (let i = 1; i < 256; i++) {
            cdf[i] += cdf[i-1];
          }
          
          // Normalize and apply
          const pixels = 800 * 600;
          for (let i = 0; i < data.length; i += 4) {
            const gray = Math.round(0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2]);
            const newGray = Math.round((cdf[gray] / pixels) * 255);
            const scale = newGray / (gray || 1);
            
            data[i] = Math.min(255, data[i] * scale);
            data[i+1] = Math.min(255, data[i+1] * scale);
            data[i+2] = Math.min(255, data[i+2] * scale);
          }
          
          ctx.putImageData(imageData, 0, 0);
          
          resolve({
            processed: canvas.toDataURL(),
            width: 800,
            height: 600
          });
        };
        img.src = dataUrl;
      });
    }

    /**
     * Simulated CNN-based palm line segmentation
     * In production, this would use TensorFlow.js or similar
     */
    function segmentPalmLines(preprocessedData) {
      // Simulate segmentation results
      const lines = {
        lifeLine: {
          detected: true,
          confidence: 0.92,
          points: generateLinePoints('curve', 50),
          thickness: Math.random() * 3 + 1,
          depth: Math.random() * 0.4 + 0.6
        },
        headLine: {
          detected: true,
          confidence: 0.89,
          points: generateLinePoints('straight', 40),
          thickness: Math.random() * 2.5 + 1,
          depth: Math.random() * 0.3 + 0.5
        },
        heartLine: {
          detected: true,
          confidence: 0.91,
          points: generateLinePoints('curve', 45),
          thickness: Math.random() * 2.8 + 1,
          depth: Math.random() * 0.35 + 0.55
        },
        fateLine: {
          detected: Math.random() > 0.3,
          confidence: Math.random() * 0.3 + 0.6,
          points: generateLinePoints('straight', 35),
          thickness: Math.random() * 2 + 0.5,
          depth: Math.random() * 0.25 + 0.4
        }
      };
      
      return lines;
    }

    function generateLinePoints(type, count) {
      const points = [];
      for (let i = 0; i < count; i++) {
        const t = i / count;
        let x, y;
        
        if (type === 'curve') {
          x = t * 600 + 100;
          y = 300 + Math.sin(t * Math.PI) * 100 + (Math.random() - 0.5) * 20;
        } else {
          x = t * 600 + 100;
          y = 300 + t * 50 + (Math.random() - 0.5) * 20;
        }
        
        points.push({ x, y });
      }
      return points;
    }

    /**
     * Extract detailed features from segmented lines
     */
    function extractDetailedFeatures(segmentedLines) {
      const features = {};
      
      Object.keys(segmentedLines).forEach(lineKey => {
        const line = segmentedLines[lineKey];
        if (!line.detected) return;
        
        const points = line.points;
        const length = calculateLineLength(points);
        const curvature = calculateCurvature(points);
        const breaks = detectBreaks(points);
        const branches = detectBranches(points);
        const islands = detectIslands(points);
        
        features[lineKey] = {
          length: length,
          depth: line.depth,
          thickness: line.thickness,
          curvature: curvature,
          breaks: breaks,
          branches: branches,
          islands: islands,
          confidence: line.confidence
        };
      });
      
      // Extract mount features
      features.mounts = extractMountFeatures();
      
      // Extract special marks
      features.specialMarks = detectSpecialMarks();
      
      return features;
    }

    function calculateLineLength(points) {
      let length = 0;
      for (let i = 1; i < points.length; i++) {
        const dx = points[i].x - points[i-1].x;
        const dy = points[i].y - points[i-1].y;
        length += Math.sqrt(dx * dx + dy * dy);
      }
      return length;
    }

    function calculateCurvature(points) {
      if (points.length < 3) return 0;
      
      let totalCurvature = 0;
      for (let i = 1; i < points.length - 1; i++) {
        const v1 = { 
          x: points[i].x - points[i-1].x,
          y: points[i].y - points[i-1].y
        };
        const v2 = {
          x: points[i+1].x - points[i].x,
          y: points[i+1].y - points[i].y
        };
        
        const angle = Math.atan2(v2.y, v2.x) - Math.atan2(v1.y, v1.x);
        totalCurvature += Math.abs(angle);
      }
      
      return totalCurvature / (points.length - 2);
    }

    function detectBreaks(points) {
      // Simulate break detection
      return Math.random() > 0.7 ? Math.floor(Math.random() * 3) : 0;
    }

    function detectBranches(points) {
      // Simulate branch detection
      return Math.random() > 0.5 ? Math.floor(Math.random() * 4) + 1 : 0;
    }

    function detectIslands(points) {
      // Simulate island detection
      return Math.random() > 0.8 ? Math.floor(Math.random() * 2) + 1 : 0;
    }

    function extractMountFeatures() {
      const mounts = {};
      Object.keys(MOUNT_AREAS).forEach(mount => {
        mounts[mount] = {
          development: Math.random() * 0.5 + 0.5, // 0.5-1.0
          firmness: Math.random() * 0.4 + 0.6,
          marks: Math.random() > 0.7 ? ['star'] : []
        };
      });
      return mounts;
    }

    function detectSpecialMarks() {
      const marks = [];
      const markTypes = Object.keys(PALM_LINES_DB.specialMarks);
      
      const markCount = Math.floor(Math.random() * 4) + 1;
      for (let i = 0; i < markCount; i++) {
        marks.push({
          type: markTypes[Math.floor(Math.random() * markTypes.length)],
          location: ['ÏÉùÎ™ÖÏÑ†', 'ÎëêÎáåÏÑ†', 'Í∞êÏ†ïÏÑ†', 'Ïö¥Î™ÖÏÑ†'][Math.floor(Math.random() * 4)],
          significance: Math.random() * 0.4 + 0.6
        });
      }
      
      return marks;
    }

    /**
     * Generate professional interpretation based on features
     */
    function generateProfessionalInterpretation(features) {
      const interpretations = {};
      
      // Analyze main lines
      Object.keys(PALM_LINES_DB).forEach(lineKey => {
        if (lineKey === 'specialMarks') return;
        
        const lineFeatures = features[lineKey];
        if (!lineFeatures) return;
        
        const lineDB = PALM_LINES_DB[lineKey];
        const interpretation = [];
        
        // Length interpretation
        if (lineFeatures.length > 400) {
          interpretation.push(lineDB.interpretation.long || 'Í∏¥ ÏÑ†');
        } else if (lineFeatures.length < 200) {
          interpretation.push(lineDB.interpretation.short || 'ÏßßÏùÄ ÏÑ†');
        }
        
        // Depth interpretation
        if (lineFeatures.depth > 0.7) {
          interpretation.push(lineDB.interpretation.deep || 'ÍπäÏùÄ ÏÑ†');
        }
        
        // Curvature interpretation
        if (lineFeatures.curvature > 0.5) {
          interpretation.push(lineDB.interpretation.curved || 'Í≥°ÏÑ†');
        } else {
          interpretation.push(lineDB.interpretation.straight || 'ÏßÅÏÑ†');
        }
        
        // Breaks and islands
        if (lineFeatures.breaks > 0) {
          interpretation.push(lineDB.interpretation.broken || 'Îã®Ï†à ÏûàÏùå');
        }
        if (lineFeatures.islands > 0) {
          interpretation.push(lineDB.interpretation.island || 'ÏÑ¨ Î¨∏Ïñë');
        }
        
        interpretations[lineKey] = {
          name: lineDB.name,
          features: lineFeatures,
          interpretation: interpretation,
          confidence: lineFeatures.confidence
        };
      });
      
      return interpretations;
    }

    /**
     * Calculate domain scores based on extracted features
     */
    function calculateDomainScores(leftFeatures, rightFeatures) {
      const domains = {
        career: calculateCareerScore(leftFeatures, rightFeatures),
        wealth: calculateWealthScore(leftFeatures, rightFeatures),
        love: calculateLoveScore(leftFeatures, rightFeatures),
        health: calculateHealthScore(leftFeatures, rightFeatures),
        personality: calculatePersonalityScore(leftFeatures, rightFeatures)
      };
      
      return domains;
    }

    function calculateCareerScore(left, right) {
      let score = 50;
      
      // Fate line contributes most to career
      if (right?.fateLine) {
        score += right.fateLine.depth * 20;
        score += right.fateLine.length > 300 ? 15 : 5;
      }
      
      // Head line affects career decisions
      if (right?.headLine) {
        score += right.headLine.clarity * 10;
      }
      
      // Jupiter mount for ambition
      if (right?.mounts?.jupiter) {
        score += right.mounts.jupiter.development * 10;
      }
      
      return Math.min(100, Math.round(score));
    }

    function calculateWealthScore(left, right) {
      let score = 50;
      
      // Sun line indicates success and wealth
      if (right?.sunLine) {
        score += 20;
      }
      
      // Mercury mount for business acumen
      if (right?.mounts?.mercury) {
        score += right.mounts.mercury.development * 15;
      }
      
      // Special marks
      const specialMarks = right?.specialMarks || [];
      specialMarks.forEach(mark => {
        if (mark.type === 'star' || mark.type === 'triangle') {
          score += 10;
        }
      });
      
      return Math.min(100, Math.round(score));
    }

    function calculateLoveScore(left, right) {
      let score = 50;
      
      // Heart line is primary for love
      const heartLine = right?.heartLine || left?.heartLine;
      if (heartLine) {
        score += heartLine.depth * 15;
        score += heartLine.branches > 2 ? 10 : 5;
      }
      
      // Venus mount for love and passion
      const venus = right?.mounts?.venus || left?.mounts?.venus;
      if (venus) {
        score += venus.development * 20;
      }
      
      return Math.min(100, Math.round(score));
    }

    function calculateHealthScore(left, right) {
      let score = 70;
      
      // Life line for vitality
      const lifeLine = left?.lifeLine || right?.lifeLine;
      if (lifeLine) {
        score += lifeLine.depth * 10;
        score -= lifeLine.breaks * 10;
        score -= lifeLine.islands * 5;
      }
      
      // Mercury line (health line) - absence is actually good
      if (!right?.mercuryLine && !left?.mercuryLine) {
        score += 10;
      }
      
      return Math.min(100, Math.max(30, Math.round(score)));
    }

    function calculatePersonalityScore(left, right) {
      let score = 60;
      
      // Head line for thinking patterns
      const headLine = right?.headLine || left?.headLine;
      if (headLine) {
        score += headLine.curvature > 0.5 ? 10 : 5; // Creative vs logical
      }
      
      // Mount development
      const mounts = right?.mounts || left?.mounts;
      if (mounts) {
        // Balanced mount development indicates balanced personality
        const developments = Object.values(mounts).map(m => m.development);
        const variance = calculateVariance(developments);
        score += (1 - variance) * 20; // Less variance = more balanced
      }
      
      return Math.min(100, Math.round(score));
    }

    function calculateVariance(values) {
      const mean = values.reduce((a, b) => a + b, 0) / values.length;
      const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
      return Math.min(1, variance);
    }

    /**
     * Generate life phase predictions based on palm analysis
     */
    function generateLifePhasePredictions(features) {
      const phases = [
        {
          age: '20-30ÏÑ∏',
          prediction: 'ÏÑ±Ïû•Í≥º ÌÉêÏÉâÏùò ÏãúÍ∏∞',
          details: 'Í≤ΩÎ†• Í∏∞Î∞ò Íµ¨Ï∂ï, Îã§ÏñëÌïú Í≤ΩÌóò Ï∂ïÏ†Å Í∂åÏû•'
        },
        {
          age: '30-40ÏÑ∏',
          prediction: 'ÏïàÏ†ïÍ≥º Î∞úÏ†ÑÏùò ÏãúÍ∏∞',
          details: 'Ï†ÑÎ¨∏ÏÑ± ÌôïÎ¶Ω, Í∞ÄÏ†ï ÏïàÏ†ïÌôî Ï§ëÏöî'
        },
        {
          age: '40-50ÏÑ∏',
          prediction: 'ÏÑ±ÏàôÍ≥º ÏàòÌôïÏùò ÏãúÍ∏∞',
          details: 'Ï∂ïÏ†ÅÎêú Í≤ΩÌóò ÌôúÏö©, Î¶¨ÎçîÏã≠ Î∞úÌúò'
        },
        {
          age: '50-60ÏÑ∏',
          prediction: 'ÏßÄÌòúÏôÄ Î©òÌÜ†ÎßÅÏùò ÏãúÍ∏∞',
          details: 'ÌõÑÎ∞∞ ÏñëÏÑ±, ÏÇ¨Ìöå Í∏∞Ïó¨ ÌôïÎåÄ'
        },
        {
          age: '60ÏÑ∏ Ïù¥ÏÉÅ',
          prediction: 'ÏÑ±Ï∞∞Í≥º Ïú†ÏÇ∞Ïùò ÏãúÍ∏∞',
          details: 'Ïù∏ÏÉù Ï†ïÎ¶¨, ÏßÄÌòú Ï†ÑÏàò'
        }
      ];
      
      // Customize based on palm features
      if (features.fateLine && features.fateLine.length > 400) {
        phases[1].details += ', Í≤ΩÎ†• ÏÉÅÏäπ Í∞ÄÎä•ÏÑ± ÎÜíÏùå';
      }
      
      if (features.lifeLine && features.lifeLine.depth > 0.7) {
        phases.forEach(phase => {
          phase.health = 'Í±¥Í∞ï ÏÉÅÌÉú ÏñëÌò∏ ÏòàÏÉÅ';
        });
      }
      
      return phases;
    }

    // ===== UI Functions =====
    
    function updateStepUI() {
      // Update step indicators
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < AppState.currentStep) {
          step.classList.add('completed');
        } else if (index + 1 === AppState.currentStep) {
          step.classList.add('active');
        }
      });
      
      // Update progress bar
      const progress = (AppState.currentStep / 5) * 100;
      document.querySelector('.progress-fill').style.width = `${progress}%`;
      
      // Show/hide step content
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`step${AppState.currentStep}`).classList.add('active');
    }

    async function nextStep() {
      if (AppState.currentStep === 1) {
        // Validate at least one image uploaded
        if (!AppState.palmImages.left && !AppState.palmImages.right) {
          showError('ÏµúÏÜå Ìïú ÏÜêÏùò Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî');
          return;
        }
        
        // Move to preprocessing
        AppState.currentStep++;
        updateStepUI();
        await performPreprocessing();
        
      } else if (AppState.currentStep === 2) {
        // Move to Saju input
        AppState.currentStep++;
        updateStepUI();
        
      } else if (AppState.currentStep === 3) {
        // Save Saju data and move to analysis
        saveSajuData();
        AppState.currentStep++;
        updateStepUI();
        
      } else if (AppState.currentStep < 5) {
        AppState.currentStep++;
        updateStepUI();
      }
    }

    function previousStep() {
      if (AppState.currentStep > 1) {
        AppState.currentStep--;
        updateStepUI();
      }
    }

    // ===== Preprocessing =====
    
    async function performPreprocessing() {
      // Process left hand if available
      if (AppState.palmImages.left) {
        AppState.preprocessedData.left = await preprocessImage(AppState.palmImages.left);
        
        // Update UI
        document.getElementById('resolution-value').textContent = 
          AppState.palmImages.quality.left.resolution;
        document.getElementById('contrast-value').textContent = 
          AppState.palmImages.quality.left.contrast + '%';
        document.getElementById('sharpness-value').textContent = 
          AppState.palmImages.quality.left.sharpness + '%';
        document.getElementById('noise-value').textContent = 'ÎÇÆÏùå';
      }
      
      // Process right hand if available
      if (AppState.palmImages.right) {
        AppState.preprocessedData.right = await preprocessImage(AppState.palmImages.right);
      }
    }

    // ===== Professional Analysis =====
    
    async function startProfessionalAnalysis() {
      const steps = [
        { id: 'preprocessing', name: 'Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨', duration: 1500 },
        { id: 'segmentation', name: 'CNN ÏÑ∏Í∑∏Î©òÌÖåÏù¥ÏÖò', duration: 2000 },
        { id: 'feature-extraction', name: 'ÌäπÏßï Ï∂îÏ∂ú', duration: 1800 },
        { id: 'pattern-matching', name: 'Ìå®ÌÑ¥ Îß§Ïπ≠', duration: 1600 },
        { id: 'report-generation', name: 'Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±', duration: 1200 }
      ];
      
      for (const step of steps) {
        const element = document.getElementById(step.id);
        
        // Animate progress
        for (let i = 0; i <= 100; i += 10) {
          element.querySelector('.progress-percentage').textContent = `${i}%`;
          await sleep(step.duration / 10);
        }
        
        element.classList.add('complete');
      }
      
      // Perform actual analysis
      await performFullAnalysis();
      
      // Move to report
      AppState.currentStep = 5;
      updateStepUI();
      renderProfessionalReport();
    }

    async function performFullAnalysis() {
      // Segment lines
      if (AppState.preprocessedData.left) {
        const leftSegmented = segmentPalmLines(AppState.preprocessedData.left);
        AppState.extractedFeatures.left = extractDetailedFeatures(leftSegmented);
      }
      
      if (AppState.preprocessedData.right) {
        const rightSegmented = segmentPalmLines(AppState.preprocessedData.right);
        AppState.extractedFeatures.right = extractDetailedFeatures(rightSegmented);
      }
      
      // Generate interpretations
      const leftInterpretation = AppState.extractedFeatures.left ? 
        generateProfessionalInterpretation(AppState.extractedFeatures.left) : null;
      const rightInterpretation = AppState.extractedFeatures.right ?
        generateProfessionalInterpretation(AppState.extractedFeatures.right) : null;
      
      // Calculate domain scores
      const domainScores = calculateDomainScores(
        AppState.extractedFeatures.left,
        AppState.extractedFeatures.right
      );
      
      // Generate life phase predictions
      const lifePhasePredictions = generateLifePhasePredictions(
        AppState.extractedFeatures.right || AppState.extractedFeatures.left
      );
      
      // Store results
      AppState.analysisResults = {
        leftInterpretation,
        rightInterpretation,
        domainScores,
        lifePhasePredictions,
        overallScore: Math.round(
          Object.values(domainScores).reduce((a, b) => a + b, 0) / 
          Object.keys(domainScores).length
        ),
        confidence: calculateConfidence()
      };
    }

    function calculateConfidence() {
      let confidence = 60;
      
      // Image quality affects confidence
      if (AppState.palmImages.quality.left) {
        confidence += AppState.palmImages.quality.left.score * 0.15;
      }
      if (AppState.palmImages.quality.right) {
        confidence += AppState.palmImages.quality.right.score * 0.15;
      }
      
      // Both hands increase confidence
      if (AppState.palmImages.left && AppState.palmImages.right) {
        confidence += 10;
      }
      
      // Saju data increases confidence
      if (AppState.sajuData.year) {
        confidence += 5;
      }
      
      return Math.min(95, Math.round(confidence));
    }

    // ===== Report Rendering =====
    
    function renderProfessionalReport() {
      const results = AppState.analysisResults;
      
      // Warning banner
      document.getElementById('global-banners').innerHTML = `
        <div class="banner warn">
          <strong>‚ö†Ô∏è Ï£ºÏùò:</strong> Î≥∏ Î∂ÑÏÑùÏùÄ Ï∞∏Í≥†Ïö©Ïù¥Î©∞, ÏùòÌïôÏ†Å¬∑Î≤ïÎ•†Ï†Å Ï°∞Ïñ∏ÏùÑ ÎåÄÏ≤¥ÌïòÏßÄ ÏïäÏäµÎãàÎã§.
          Ïã†Î¢∞ÎèÑ: ${results.confidence}%
        </div>
      `;
      
      // Score cards
      renderScoreCards(results.domainScores, results.overallScore);
      
      // Main lines analysis
      renderMainLinesAnalysis(results.rightInterpretation || results.leftInterpretation);
      
      // Auxiliary lines analysis
      renderAuxiliaryLinesAnalysis();
      
      // Professional interpretation
      renderProfessionalInterpretation(results.domainScores);
      
      // Life phase predictions
      renderLifePhasePredictions(results.lifePhasePredictions);
    }

    function renderScoreCards(domainScores, overallScore) {
      const grid = document.getElementById('result-grid');
      
      grid.innerHTML = `
        <div class="result-card clickable" data-domain="overall">
          <div class="result-score">${overallScore}</div>
          <div class="result-label">Ï¢ÖÌï© Ï†êÏàò</div>
        </div>
      `;
      
      const domainNames = {
        career: 'Í≤ΩÎ†•/ÏÑ±Í≥µ',
        wealth: 'Ïû¨Î¨ºÏö¥',
        love: 'Ïï†Ï†ïÏö¥',
        health: 'Í±¥Í∞ïÏö¥',
        personality: 'ÏÑ±Í≤©/Í∏∞Ïßà'
      };
      
      Object.entries(domainScores).forEach(([domain, score]) => {
        grid.innerHTML += `
          <div class="result-card clickable" data-domain="${domain}">
            <div class="result-score">${score}</div>
            <div class="result-label">${domainNames[domain]}</div>
          </div>
        `;
      });
      
      // Add click handlers
      grid.addEventListener('click', (e) => {
        const card = e.target.closest('.result-card');
        if (card) {
          showDetailModal(card.dataset.domain);
        }
      });
    }

    function renderMainLinesAnalysis(interpretation) {
      const container = document.getElementById('main-lines-analysis');
      
      const mainLines = ['lifeLine', 'headLine', 'heartLine', 'fateLine'];
      
      mainLines.forEach(lineKey => {
        const lineData = interpretation?.[lineKey];
        if (!lineData) return;
        
        const html = `
          <div class="line-analysis">
            <h4>
              ${lineData.name}
              <span class="line-badge">Ïã†Î¢∞ÎèÑ ${Math.round((lineData.confidence || 0.8) * 100)}%</span>
            </h4>
            <ul class="feature-list">
              <li>
                <span class="feature-label">Í∏∏Ïù¥</span>
                <span class="feature-value">${Math.round(lineData.features?.length || 0)}px</span>
              </li>
              <li>
                <span class="feature-label">ÍπäÏù¥</span>
                <span class="feature-value">${((lineData.features?.depth || 0) * 100).toFixed(1)}%</span>
              </li>
              <li>
                <span class="feature-label">ÌäπÏßï</span>
                <span class="feature-value">${lineData.interpretation.join(', ')}</span>
              </li>
            </ul>
          </div>
        `;
        
        container.innerHTML += html;
      });
    }

    function renderAuxiliaryLinesAnalysis() {
      const container = document.getElementById('auxiliary-lines-analysis');
      
      // Simulate auxiliary lines detection
      const auxiliaryLines = {
        sunLine: { detected: Math.random() > 0.5, interpretation: 'ÏÑ±Í≥µÍ≥º Î™ÖÏòàÏùò Í∞ÄÎä•ÏÑ±' },
        mercuryLine: { detected: Math.random() > 0.7, interpretation: 'ÏÇ¨ÏóÖ ÏàòÏôÑ' },
        marriageLines: { count: Math.floor(Math.random() * 3) + 1, interpretation: 'ÍπäÏùÄ Ïù∏Ïó∞' },
        childrenLines: { count: Math.floor(Math.random() * 4), interpretation: 'ÏûêÎÖÄÏö¥' },
        intuitionLine: { detected: Math.random() > 0.8, interpretation: 'ÏßÅÍ¥ÄÎ†•' }
      };
      
      let html = '<ul class="feature-list">';
      
      Object.entries(auxiliaryLines).forEach(([key, data]) => {
        if (data.detected || data.count > 0) {
          html += `
            <li>
              <span class="feature-label">${PALM_LINES_DB[key]?.name || key}</span>
              <span class="feature-value">${data.interpretation}</span>
            </li>
          `;
        }
      });
      
      html += '</ul>';
      container.innerHTML = html;
    }

    function renderProfessionalInterpretation(domainScores) {
      const container = document.getElementById('interpretation-grid');
      
      const interpretations = {
        career: {
          title: 'Í≤ΩÎ†•Í≥º ÏÑ±Í≥µ',
          high: 'Í∞ïÌïú ÏïºÎßùÍ≥º Î¶¨ÎçîÏã≠ÏùÑ Î≥¥Ïú†ÌïòÍ≥† ÏûàÏúºÎ©∞, Î™©Ìëú Îã¨ÏÑ± Îä•Î†•Ïù¥ Îõ∞Ïñ¥ÎÇ©ÎãàÎã§.',
          medium: 'ÏïàÏ†ïÏ†ÅÏù∏ Í≤ΩÎ†• Î∞úÏ†ÑÏù¥ ÏòàÏÉÅÎêòÎ©∞, Íæ∏Ï§ÄÌïú ÎÖ∏Î†•ÏúºÎ°ú ÏÑ±Í≥ºÎ•º ÏñªÏùÑ Ïàò ÏûàÏäµÎãàÎã§.',
          low: 'Í≤ΩÎ†•Ïóê ÎåÄÌïú Ïû¨Í≤ÄÌÜ†Í∞Ä ÌïÑÏöîÌïòÎ©∞, ÏÉàÎ°úÏö¥ Í∏∞ÌöåÎ•º Î™®ÏÉâÌïòÎäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§.'
        },
        wealth: {
          title: 'Ïû¨Î¨ºÍ≥º ÌíçÏöî',
          high: 'Ïû¨Î¨º Ï∂ïÏ†Å Îä•Î†•Ïù¥ Îõ∞Ïñ¥ÎÇòÎ©∞, Îã§ÏñëÌïú ÏàòÏûÖÏõêÏùÑ Í∞úÎ∞úÌï† Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏäµÎãàÎã§.',
          medium: 'ÏïàÏ†ïÏ†ÅÏù∏ Ïû¨Ï†ï ÏÉÅÌÉúÎ•º Ïú†ÏßÄÌï† Ïàò ÏûàÏúºÎ©∞, Í≥ÑÌöçÏ†ÅÏù∏ Í¥ÄÎ¶¨Í∞Ä Ï§ëÏöîÌï©ÎãàÎã§.',
          low: 'Ïû¨Ï†ï Í¥ÄÎ¶¨Ïóê Îçî ÎßéÏùÄ Ï£ºÏùòÍ∞Ä ÌïÑÏöîÌïòÎ©∞, Ï∂©ÎèôÏ†ÅÏù∏ ÏßÄÏ∂úÏùÑ ÌîºÌï¥Ïïº Ìï©ÎãàÎã§.'
        },
        love: {
          title: 'ÏÇ¨ÎûëÍ≥º Í¥ÄÍ≥Ñ',
          high: 'ÍπäÍ≥† ÏùòÎØ∏ ÏûàÎäî Í¥ÄÍ≥ÑÎ•º ÌòïÏÑ±Ìï† Îä•Î†•Ïù¥ ÏûàÏúºÎ©∞, Í∞êÏ†ï ÌëúÌòÑÏù¥ ÌíçÎ∂ÄÌï©ÎãàÎã§.',
          medium: 'ÏïàÏ†ïÏ†ÅÏù∏ Í¥ÄÍ≥ÑÎ•º Ïú†ÏßÄÌï† Ïàò ÏûàÏúºÎ©∞, ÏÜåÌÜµ ÎÖ∏Î†•Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.',
          low: 'Í¥ÄÍ≥ÑÏóêÏÑú Îçî ÎßéÏùÄ Í∞úÎ∞©ÏÑ±Í≥º Ïã†Î¢∞Í∞Ä ÌïÑÏöîÌïòÎ©∞, ÏûêÍ∏∞ ÏÑ±Ï∞∞Ïù¥ ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§.'
        },
        health: {
          title: 'Í±¥Í∞ïÍ≥º ÌôúÎ†•',
          high: 'Í∞ïÌïú ÏÉùÎ™ÖÎ†•Í≥º ÌöåÎ≥µÎ†•ÏùÑ Î≥¥Ïú†ÌïòÍ≥† ÏûàÏúºÎ©∞, Í±¥Í∞ïÌïú ÏÉùÌôúÏäµÍ¥ÄÏùÑ Ïú†ÏßÄÌïòÍ≥† ÏûàÏäµÎãàÎã§.',
          medium: 'Ï†ÑÎ∞òÏ†ÅÏúºÎ°ú Í±¥Í∞ïÌïòÎÇò Ïä§Ìä∏Î†àÏä§ Í¥ÄÎ¶¨Í∞Ä ÌïÑÏöîÌïòÎ©∞, Í∑úÏπôÏ†ÅÏù∏ Ïö¥ÎèôÏù¥ Í∂åÏû•Îê©ÎãàÎã§.',
          low: 'Í±¥Í∞ïÏóê Îçî ÎßéÏùÄ Í¥ÄÏã¨Ïù¥ ÌïÑÏöîÌïòÎ©∞, Ï†ïÍ∏∞Ï†ÅÏù∏ Í±¥Í∞ï Í≤ÄÏßÑÏùÑ Î∞õÎäî Í≤ÉÏù¥ Ï¢ãÏäµÎãàÎã§.'
        },
        personality: {
          title: 'ÏÑ±Í≤©Í≥º Í∏∞Ïßà',
          high: 'Í∑†Ìòï Ïû°Ìûå ÏÑ±Í≤©ÏúºÎ°ú Îã§ÏñëÌïú ÏÉÅÌô©Ïóê Ïûò Ï†ÅÏùëÌïòÎ©∞, ÌÉÄÏù∏Í≥ºÏùò Ï°∞ÌôîÎ•º Ïù¥Î£πÎãàÎã§.',
          medium: 'ÏïàÏ†ïÏ†ÅÏù∏ ÏÑ±Í≤©Ïù¥ÎÇò ÎïåÎ°úÎäî Ïú†Ïó∞ÏÑ±Ïù¥ ÌïÑÏöîÌïòÎ©∞, ÏÉàÎ°úÏö¥ Í≤ΩÌóòÏóê Í∞úÎ∞©Ï†ÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.',
          low: 'ÏûêÍ∏∞ Ïù¥Ìï¥ÏôÄ ÏÑ±Ïû•Ïù¥ ÌïÑÏöîÌïòÎ©∞, Í∞êÏ†ï Ï°∞Ï†à Îä•Î†•ÏùÑ Ìñ•ÏÉÅÏãúÌÇ§Îäî Í≤ÉÏù¥ ÎèÑÏõÄÏù¥ Îê©ÎãàÎã§.'
        }
      };
      
      Object.entries(domainScores).forEach(([domain, score]) => {
        const interp = interpretations[domain];
        let text;
        
        if (score >= 80) text = interp.high;
        else if (score >= 60) text = interp.medium;
        else text = interp.low;
        
        container.innerHTML += `
          <div class="interpretation-card">
            <h4>üéØ ${interp.title}</h4>
            <p>${text}</p>
            <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
              Ï†êÏàò: ${score}/100
            </p>
          </div>
        `;
      });
    }

    function renderLifePhasePredictions(predictions) {
      const container = document.getElementById('life-phase-analysis');
      
      let html = '<div style="padding: 15px;">';
      
      predictions.forEach(phase => {
        html += `
          <div style="margin-bottom: 20px; padding: 15px; background: var(--light); border-radius: 10px;">
            <h4 style="color: var(--primary); margin-bottom: 8px;">${phase.age}</h4>
            <p style="font-weight: 600; margin-bottom: 5px;">${phase.prediction}</p>
            <p style="font-size: 0.95rem; color: #666;">${phase.details}</p>
            ${phase.health ? `<p style="font-size: 0.9rem; color: var(--success); margin-top: 5px;">‚úì ${phase.health}</p>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // ===== Event Handlers =====
    
    async function handleImageUpload(file, hand) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        const dataUrl = e.target.result;
        
        // Evaluate image quality
        const quality = await evaluateImageQuality(dataUrl);
        
        // Store image and quality
        AppState.palmImages[hand] = dataUrl;
        AppState.palmImages.quality[hand] = quality;
        
        // Update UI
        updateImagePreview(hand, dataUrl, quality);
      };
      reader.readAsDataURL(file);
    }

    function updateImagePreview(hand, dataUrl, quality) {
      const preview = document.getElementById(`${hand}-preview`);
      const badge = document.getElementById(`${hand}-quality`);
      const card = preview.closest('.upload-card');
      
      // Show preview
      preview.src = dataUrl;
      preview.classList.add('visible');
      card.classList.add('has-image');
      
      // Update quality badge
      let qualityClass = 'quality-low';
      let qualityText = 'ÎÇÆÏùå';
      
      if (quality.score >= 80) {
        qualityClass = 'quality-high';
        qualityText = 'ÎÜíÏùå';
      } else if (quality.score >= 60) {
        qualityClass = 'quality-medium';
        qualityText = 'Î≥¥ÌÜµ';
      }
      
      badge.className = `quality-badge ${qualityClass}`;
      badge.textContent = `ÌíàÏßà: ${qualityText} (${quality.score})`;
    }

    function saveSajuData() {
      AppState.sajuData = {
        year: document.getElementById('birth-year').value,
        month: document.getElementById('birth-month').value,
        day: document.getElementById('birth-day').value,
        hour: document.getElementById('birth-hour').value,
        gender: document.getElementById('gender').value,
        isLunar: document.getElementById('lunar-calendar').checked
      };
    }

    function showDetailModal(domain) {
      const modal = document.getElementById('detail-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      
      const domainNames = {
        overall: 'Ï¢ÖÌï© Î∂ÑÏÑù',
        career: 'Í≤ΩÎ†•Í≥º ÏÑ±Í≥µ',
        wealth: 'Ïû¨Î¨ºÏö¥',
        love: 'Ïï†Ï†ïÏö¥',
        health: 'Í±¥Í∞ïÏö¥',
        personality: 'ÏÑ±Í≤©Í≥º Í∏∞Ïßà'
      };
      
      title.textContent = domainNames[domain];
      
      // Generate detailed content
      body.innerHTML = `
        <h3>ÏÉÅÏÑ∏ Î∂ÑÏÑù Í≤∞Í≥º</h3>
        <p>Ïù¥ ÏòÅÏó≠Ïóê ÎåÄÌïú Ïã¨Ï∏µ Î∂ÑÏÑù ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</p>
      `;
      
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
      document.body.style.overflow = '';
    }

    function resetAnalysis() {
      if (!confirm('Î™®Îì† Î∂ÑÏÑù ÎÇ¥Ïö©Ïù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        return;
      }
      
      // Reset state
      AppState.currentStep = 1;
      AppState.palmImages = { left: null, right: null, quality: { left: null, right: null } };
      AppState.preprocessedData = { left: null, right: null };
      AppState.sajuData = {};
      AppState.analysisResults = null;
      AppState.extractedFeatures = { left: null, right: null };
      
      // Reset UI
      updateStepUI();
      
      // Clear images
      ['left', 'right'].forEach(hand => {
        const preview = document.getElementById(`${hand}-preview`);
        const badge = document.getElementById(`${hand}-quality`);
        const card = preview.closest('.upload-card');
        
        preview.src = '';
        preview.classList.remove('visible');
        card.classList.remove('has-image');
        badge.textContent = '';
      });
      
      // Clear form
      document.getElementById('saju-form').reset();
      
      // Clear analysis progress
      document.querySelectorAll('.analysis-step').forEach(step => {
        step.classList.remove('complete');
        step.querySelector('.progress-percentage').textContent = '0%';
      });
      
      // Clear results
      document.getElementById('result-grid').innerHTML = '';
      document.getElementById('main-lines-analysis').innerHTML = '';
      document.getElementById('auxiliary-lines-analysis').innerHTML = '';
      document.getElementById('interpretation-grid').innerHTML = '';
      document.getElementById('life-phase-analysis').innerHTML = '';
      document.getElementById('global-banners').innerHTML = '';
    }

    function exportProfessionalReport() {
      if (!AppState.analysisResults) {
        showError('ÎÇ¥Î≥¥ÎÇº Î¶¨Ìè¨Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§');
        return;
      }
      
      // Generate CSV
      const results = AppState.analysisResults;
      const csv = [
        ['PalmAI Pro Professional Report'],
        ['ÏÉùÏÑ±ÏùºÏãú', new Date().toLocaleString()],
        ['Ïã†Î¢∞ÎèÑ', results.confidence + '%'],
        [''],
        ['ÏòÅÏó≠', 'Ï†êÏàò'],
        ['Ï¢ÖÌï©', results.overallScore],
        ...Object.entries(results.domainScores).map(([domain, score]) => [domain, score]),
        [''],
        ['ÏÉùÏï†Ï£ºÍ∏∞ ÏòàÏ∏°'],
        ...results.lifePhasePredictions.map(phase => [phase.age, phase.prediction])
      ].map(row => row.join(',')).join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `PalmAI_Professional_Report_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    }

    function showError(message) {
      const banner = document.createElement('div');
      banner.className = 'banner error';
      banner.innerHTML = `<strong>Ïò§Î•ò:</strong> ${message}`;
      
      const container = document.querySelector('.step-content.active');
      container.insertBefore(banner, container.querySelector('.btn-group'));
      
      setTimeout(() => banner.remove(), 5000);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ===== Initialization =====
    
    document.addEventListener('DOMContentLoaded', () => {
      // Upload handlers
      document.getElementById('left-hand-input').addEventListener('change', (e) => {
        handleImageUpload(e.target.files[0], 'left');
      });
      
      document.getElementById('right-hand-input').addEventListener('change', (e) => {
        handleImageUpload(e.target.files[0], 'right');
      });
      
      // Step navigation
      document.querySelectorAll('.step').forEach(step => {
        step.addEventListener('click', () => {
          const targetStep = parseInt(step.dataset.step);
          if (targetStep <= AppState.currentStep) {
            AppState.currentStep = targetStep;
            updateStepUI();
          }
        });
      });
      
      // ESC to close modal
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    });
  </script>
</body>
</html>