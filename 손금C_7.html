<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PalmAI Pro - v9.2 (Interactive Modal Edition)</title>
  <style>
    :root{
      --primary:#6a11cb;--secondary:#2575fc;--success:#00b894;--danger:#d63031;--warning:#fdcb6e;
      --dark:#2d3436;--light:#f5f6fa;--text:#2c3e50;--border:#dfe6e9;--shadow:0 5px 20px rgba(0,0,0,.1);
      --transition:all .3s cubic-bezier(.4,0,.2,1)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:linear-gradient(135deg,var(--primary),var(--secondary));min-height:100vh;color:var(--text);line-height:1.6}
    .main-container{max-width:1200px;margin:0 auto;padding:20px}
    .app-header{color:#fff;text-align:center;padding:40px 20px}
    .app-header h1{font-size:2.2rem;margin-bottom:8px;text-shadow:2px 2px 6px rgba(0,0,0,.25)}
    .step-navigation{background:#fff;border-radius:18px;padding:22px;margin-bottom:22px;box-shadow:var(--shadow)}
    .steps{display:flex;justify-content:space-between;position:relative;margin-bottom:16px}
    .steps:before{content:'';position:absolute;left:0;right:0;top:20px;height:2px;background:var(--border)}
    .step{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;z-index:1}
    .step-number{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;background:var(--light);border:2px solid var(--border)}
    .step.active .step-number{background:var(--primary);color:#fff;border-color:var(--primary);transform:scale(1.1)}
    .step.completed .step-number{background:var(--success);color:#fff;border-color:var(--success)}
    .step-label{font-size:.9rem}
    .progress-bar{height:8px;background:var(--border);border-radius:10px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(135deg,var(--primary),var(--secondary));width:25%;transition:width .5s}
    .content-area{background:#fff;border-radius:18px;padding:22px;box-shadow:var(--shadow);min-height:520px}
    .step-content{display:none}.step-content.active{display:block}
    .upload-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin:20px 0}
    .upload-card{border:3px dashed var(--border);border-radius:16px;padding:32px 18px;text-align:center;cursor:pointer;position:relative;background:var(--light);transition:var(--transition)}
    .upload-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}
    .upload-card.has-image{border-style:solid;border-color:var(--success)}
    .upload-icon{font-size:2.6rem;margin-bottom:10px}
    .upload-preview{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:12px;opacity:0;transition:opacity .3s}
    .upload-preview.visible{opacity:1}
    .quality-badge{position:absolute;top:10px;right:10px;padding:6px 12px;border-radius:20px;font-size:.85rem;font-weight:700;color:#fff;z-index:2}
    .quality-high{background:var(--success)}.quality-medium{background:var(--warning)}.quality-low{background:var(--danger)}
    .saju-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:18px 0}
    .form-control{padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1rem}
    .form-control.error{border-color:var(--danger)}
    .error-message{display:none;color:var(--danger);font-size:.85rem;margin-top:6px}
    .error-message.show{display:block}
    .btn{padding:12px 24px;border:none;border-radius:10px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .btn-secondary{background:var(--light);border:2px solid var(--border)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-group{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:16px}
    .analysis-progress{margin:20px 0}
    .analysis-step{padding:14px;margin:10px 0;background:var(--light);border-left:4px solid var(--primary);display:flex;justify-content:space-between;align-items:center}
    .analysis-step.completed{border-left-color:var(--success);background:rgba(0,184,148,.08)}
    .analysis-step.error{border-left-color:var(--danger);background:rgba(214,48,49,.08)}
    .progress-percentage{font-weight:800;color:var(--primary)}
    .result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:18px 0}
    .result-card{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:18px 16px;border-radius:16px;text-align:center;white-space:nowrap;transition:all .3s;position:relative;overflow:hidden}
    .result-card.clickable{cursor:pointer}
    .result-card.clickable:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(106,17,203,.3)}
    .result-card.clickable:hover::after{content:'ğŸ“Š ìƒì„¸ë³´ê¸°';position:absolute;bottom:8px;right:8px;font-size:.75rem;opacity:.9}
    .result-score{font-size:2.1rem;font-weight:900}
    .result-card .result-sub{font-size:.9rem;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .expert-card{background:#fff;border-left:5px solid var(--primary);border-radius:12px;padding:18px;margin:14px 0;box-shadow:var(--shadow)}
    .banner{padding:10px 14px;border-radius:10px;margin:10px 0;font-size:.95rem}
    .banner.warn{background:#fff7e6;border:1px solid #ffd591}
    .banner.error{background:#ffecec;border:1px solid #ffb3b3}
    .guide-list li{margin-left:18px}
    #palm-canvas{max-width:100%;border-radius:12px;border:2px solid var(--border);margin-top:10px;background:#f8fafc}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:9999}
    .overlay.active{display:flex}
    .overlay-card{background:#fff;color:#222;border-radius:14px;padding:20px;max-width:720px;width:92%;max-height:85vh;overflow-y:auto}
    .loading-spinner{width:56px;height:56px;border:4px solid rgba(0,0,0,.12);border-top-color:#6a11cb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
    .loading-progress{width:220px;height:6px;background:rgba(0,0,0,.1);border-radius:3px;margin:10px auto;overflow:hidden}
    .loading-progress-bar{height:100%;background:#6a11cb;width:0%;transition:width .3s}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Modal Styles */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(5px)}
    .modal-overlay.active{display:flex}
    .modal-content{background:#fff;border-radius:20px;max-width:680px;width:92%;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:modalSlide .3s ease}
    @keyframes modalSlide{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:20px 25px;position:relative}
    .modal-header h2{font-size:1.5rem;display:flex;align-items:center;gap:12px}
    .modal-close{position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.2);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;transition:.2s}
    .modal-close:hover{background:rgba(255,255,255,.3)}
    .modal-body{padding:25px;overflow-y:auto;max-height:60vh}
    .modal-section{margin-bottom:25px;padding:20px;background:#f8f9fa;border-radius:12px;border-left:4px solid var(--primary)}
    .modal-section h3{color:var(--primary);margin-bottom:12px;font-size:1.1rem}
    .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:15px 0}
    .metric-box{background:#fff;padding:12px;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .metric-value{font-size:1.8rem;font-weight:bold;color:var(--primary)}
    .metric-label{font-size:.85rem;color:#666;margin-top:4px}
    .action-item{display:flex;align-items:start;gap:12px;margin:12px 0;padding:10px;background:#fff;border-radius:8px}
    .action-icon{font-size:1.2rem;margin-top:2px}
    .score-link{color:var(--primary);text-decoration:underline;cursor:pointer;font-weight:600}
    .score-link:hover{color:var(--secondary)}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.7/purify.min.js"></script>
</head>
<body>
  <header class="app-header">
    <h1>ğŸ–ï¸ PalmAI Pro v9.2</h1>
    <p>ì†ì˜ í˜•íƒœÂ·ì†ê¸ˆ ì „ìš”ì†ŒÂ·êµ¬ë¦‰Â·ë¬¸ì–‘Â·ìƒ‰ìƒ + ì‚¬ì£¼ ë³´ì¡° + ê³¼í•™Â·ì˜í•™ ì°¸ê³ </p>
  </header>

  <main class="main-container">
    <nav class="step-navigation">
      <div class="steps">
        <div class="step active" data-step="1"><div class="step-number">1</div><div class="step-label">ì†ê¸ˆ ì—…ë¡œë“œ</div></div>
        <div class="step" data-step="2"><div class="step-number">2</div><div class="step-label">ì‚¬ì£¼ ì…ë ¥</div></div>
        <div class="step" data-step="3"><div class="step-number">3</div><div class="step-label">AI ë¶„ì„</div></div>
        <div class="step" data-step="4"><div class="step-number">4</div><div class="step-label">ê²°ê³¼</div></div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:25%"></div></div>
    </nav>

    <div class="content-area">
      <section class="step-content active" id="step1">
        <h2>ì†ê¸ˆ ì‚¬ì§„ ì—…ë¡œë“œ (í•„ìˆ˜)</h2>
        <div class="banner warn"><strong>Tip:</strong> ë‘ ì† ëª¨ë‘ ì˜¬ë¦´ìˆ˜ë¡ ì •í™•ë„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</div>
        <div class="btn-group" style="justify-content:flex-start">
          <button class="btn btn-secondary" onclick="openGuide()">ğŸ“¸ ì´¬ì˜ ê°€ì´ë“œ</button>
          <button class="btn btn-secondary" onclick="showPrivacyInfo()">ğŸ”’ ê°œì¸ì •ë³´</button>
        </div>
        <div class="upload-grid">
          <div class="upload-card" id="left-upload">
            <input type="file" id="left-hand-input" accept="image/*" capture="environment" style="display:none"/>
            <div class="upload-icon">ğŸ¤š</div>
            <h3>ì™¼ì† (ì„ ì²œìš´)</h3>
            <p>í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
            <img class="upload-preview" id="left-preview" alt="ì™¼ì† ë¯¸ë¦¬ë³´ê¸°"/>
            <div class="quality-badge" id="left-quality"></div>
          </div>
          <div class="upload-card" id="right-upload">
            <input type="file" id="right-hand-input" accept="image/*" capture="environment" style="display:none"/>
            <div class="upload-icon">ğŸ–ï¸</div>
            <h3>ì˜¤ë¥¸ì† (í›„ì²œìš´)</h3>
            <p>í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
            <img class="upload-preview" id="right-preview" alt="ì˜¤ë¥¸ì† ë¯¸ë¦¬ë³´ê¸°"/>
            <div class="quality-badge" id="right-quality"></div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="nextStep()">ë‹¤ìŒ ë‹¨ê³„</button>
        </div>
      </section>

      <section class="step-content" id="step2">
        <h2>ì‚¬ì£¼ ì •ë³´ ì…ë ¥ (ë³´ì¡°)</h2>
        <div id="saju-warning"></div>
        <form class="saju-form" id="saju-form">
          <div>
            <label for="birth-year">ìƒë…„</label>
            <input type="number" class="form-control" id="birth-year" min="1900" max="2100" required/>
            <div class="error-message" id="year-error"></div>
          </div>
          <div>
            <label for="birth-month">ìƒì›”</label>
            <input type="number" class="form-control" id="birth-month" min="1" max="12" required/>
            <div class="error-message" id="month-error"></div>
          </div>
          <div>
            <label for="birth-day">ìƒì¼</label>
            <input type="number" class="form-control" id="birth-day" min="1" max="31" required/>
            <div class="error-message" id="day-error"></div>
          </div>
          <div>
            <label for="birth-hour">ìƒì‹œ</label>
            <select class="form-control" id="birth-hour">
              <option value="-1">ëª¨ë¦„</option>
              <option value="0">ì(23-01)</option><option value="2">ì¶•(01-03)</option><option value="4">ì¸(03-05)</option>
              <option value="6">ë¬˜(05-07)</option><option value="8">ì§„(07-09)</option><option value="10">ì‚¬(09-11)</option>
              <option value="12">ì˜¤(11-13)</option><option value="14">ë¯¸(13-15)</option><option value="16">ì‹ (15-17)</option>
              <option value="18">ìœ (17-19)</option><option value="20">ìˆ (19-21)</option><option value="22">í•´(21-23)</option>
            </select>
          </div>
          <div>
            <label for="gender">ì„±ë³„</label>
            <select class="form-control" id="gender" required>
              <option value="">ì„ íƒ</option><option value="male">ë‚¨ì„±</option><option value="female">ì—¬ì„±</option>
            </select>
            <div class="error-message" id="gender-error"></div>
          </div>
          <div>
            <label for="lunar-calendar">ìŒë ¥(ìœ¤ë‹¬ í¬í•¨)</label>
            <input type="checkbox" id="lunar-calendar"/>
          </div>
        </form>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previousStep()">ì´ì „</button>
          <button class="btn btn-primary" onclick="nextStep()">ë‹¤ìŒ</button>
        </div>
      </section>

      <section class="step-content" id="step3">
        <h2>AI ë¶„ì„ ì§„í–‰</h2>
        <div class="analysis-progress">
          <div class="analysis-step" id="palm-detection"><span>ì†ê¸ˆì„ /ë¬¸ì–‘/í˜•íƒœ ê²€ì¶œ...</span><span class="progress-percentage">0%</span></div>
          <div class="analysis-step" id="saju-calculation"><span>ì‚¬ì£¼ ë³´ì¡° ë¶„ì„...</span><span class="progress-percentage">0%</span></div>
          <div class="analysis-step" id="integration"><span>í†µí•© ìŠ¤ì½”ì–´ë§...</span><span class="progress-percentage">0%</span></div>
        </div>
        <canvas id="palm-canvas" width="960" height="640"></canvas>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previousStep()">ì´ì „</button>
          <button class="btn btn-primary" id="analysis-button" onclick="startAnalysis()">ë¶„ì„ ì‹œì‘</button>
          <button class="btn btn-danger" id="cancel-button" onclick="cancelAnalysis()" style="display:none">ë¶„ì„ ì·¨ì†Œ</button>
        </div>
      </section>

      <section class="step-content" id="step4">
        <h2>ì¢…í•© ê²°ê³¼</h2>
        <div id="global-banners"></div>
        <div class="result-grid" id="result-grid"></div>
        <div class="detailed-result" id="detailed-result"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="exportResults()">PDF</button>
          <button class="btn btn-secondary" onclick="exportCSV()">CSV</button>
          <button class="btn btn-primary" onclick="exportToSheets()">Sheetsë¡œ ë‚´ë³´ë‚´ê¸°</button>
        </div>
      </section>
    </div>
  </main>

  <!-- Score Detail Modal -->
  <div class="modal-overlay" id="score-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">ğŸ“Š ì¬ë¬¼ìš´ ìƒì„¸ ë¶„ì„</h2>
        <button class="modal-close" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="overlay" id="loading">
    <div class="overlay-card" style="max-width:420px">
      <div class="loading-spinner"></div>
      <div id="loading-text" style="text-align:center">ë¶„ì„ ì¤‘...</div>
      <div class="loading-progress"><div class="loading-progress-bar" id="loading-progress-bar"></div></div>
      <div id="loading-percentage" style="text-align:center">0%</div>
      <div class="btn-group" style="justify-content:center;margin-top:10px">
        <button class="btn btn-danger" onclick="cancelAnalysis()">ë¶„ì„ ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- Guide Modal -->
  <div class="overlay" id="guide">
    <div class="overlay-card">
      <h3 style="margin-bottom:10px;color:var(--primary)">ğŸ“¸ ì†ê¸ˆ ì´¬ì˜ ê°€ì´ë“œ</h3>
      <ul class="guide-list">
        <li><strong>ë°ì€ ë‹¨ìƒ‰ ë°°ê²½</strong> ìœ„ì—ì„œ ì´¬ì˜ (í°ìƒ‰ ì²œ/ì¢…ì´ ì¶”ì²œ)</li>
        <li>ì†ë°”ë‹¥ì„ <strong>ì™„ì „íˆ í´ê³ </strong>, ì†ê°€ë½ì€ <strong>ê³¼ë„í•˜ê²Œ ëª¨ìœ¼ì§€ ì•Šê¸°</strong></li>
        <li><strong>í”Œë˜ì‹œ/ê°•í•œ ì¡°ëª…</strong>ìœ¼ë¡œ ì„ ì˜ ëª…ì•” ëŒ€ë¹„ í™•ë³´, ê·¸ë¦¼ì ìµœì†Œí™”</li>
        <li>ì† ì „ì²´ê°€ í”„ë ˆì„ì— ë“¤ì–´ì˜¤ë„ë¡, <strong>í™”ë©´ 80% ì´ìƒ</strong> ì±„ìš°ê¸°</li>
        <li>ì¹´ë©”ë¼ëŠ” ì†ì—ì„œ <strong>ì•½ 25~35cm</strong> ê±°ë¦¬, í”ë“¤ë¦¼ ë°©ì§€</li>
      </ul>
      <div class="btn-group" style="justify-content:flex-end;margin-top:12px"><button class="btn btn-primary" onclick="closeGuide()">í™•ì¸</button></div>
    </div>
  </div>

  <!-- Privacy Modal -->
  <div class="overlay" id="privacy-modal">
    <div class="overlay-card" style="max-width:560px">
      <h3 style="margin-bottom:10px;color:var(--primary)">ğŸ”’ ê°œì¸ì •ë³´ ë³´í˜¸ ì•ˆë‚´</h3>
      <ul>
        <li>ëª¨ë“  ë°ì´í„°ëŠ” ì•”í˜¸í™”ë˜ì–´ ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤.</li>
        <li>ì„œë²„ í†µì‹  ì‹œ SSL/TLSë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
        <li>ë¶„ì„ í›„ ì›ë³¸ ì´ë¯¸ì§€ëŠ” ì¦‰ì‹œ ì‚­ì œë©ë‹ˆë‹¤.</li>
        <li>ì–¸ì œë“ ì§€ ë°ì´í„° ì‚­ì œë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
      </ul>
      <p style="margin-top:10px"><strong>ì£¼ì˜:</strong> ë³¸ ì„œë¹„ìŠ¤ëŠ” ì˜¤ë½ ë° ì°¸ê³ ìš©ì´ë©°, ì˜ë£ŒÂ·ë²•ë¥  ì¡°ì–¸ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
      <div class="btn-group" style="justify-content:flex-end;margin-top:12px"><button class="btn btn-primary" onclick="closePrivacyModal()">í™•ì¸</button></div>
    </div>
  </div>

  <script>
    // CONFIG
    const PalmAI_CONFIG = {
      BACKEND_BASE: "https://api.yourdomain.com",
      ENDPOINTS: { SAJU: "/saju/calculate", INFER: "/palm/infer", FEEDBACK:"/feedback" },
      FEATURES: { useBackendSaju: true, requireSaju: true, useBackendInference: true },
      WEIGHTS: { palm:0.8, saju:0.2, qualityImpact:0.35 },
      OVERLAY: { drawSpecialMarks:true, lineWidth:3 },
      SCIENTIFIC: { enableMedicalScreening: true, enableMLAnalysis: true, minConfidence: 0.65 }
    };

    const AppState = {
      currentStep: 1, currentAge: 0,
      palmImages: { left:null, right:null, quality:{left:null,right:null} },
      sajuData: { year:null, month:null, day:null, hour:null, gender:null, isLunar:false },
      analysisResults: null,
      banners:[],
      modalData: null
    };

    // Modal System
    function showScoreModal(scoreType) {
      const modal = document.getElementById('score-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      
      // Get score data
      const results = AppState.analysisResults;
      if (!results) return;
      
      const scores = results.scores;
      const palm = results.palmResults?.right || results.palmResults?.left || {};
      const aux = palm.auxiliaryLines || {};
      const mounts = palm.mounts || {};
      
      // Set title
      const titles = {
        wealth: 'ğŸ’° ì¬ë¬¼ìš´',
        career: 'ğŸ’¼ ì§ì—…ìš´',
        love: 'â¤ï¸ ì• ì •ìš´',
        health: 'ğŸ¥ ê±´ê°•ìš´',
        resilience: 'ğŸ’ª íšŒë³µ íƒ„ë ¥ì„±',
        stressLoad: 'ğŸ˜° ìŠ¤íŠ¸ë ˆìŠ¤ ë¶€í•˜'
      };
      
      title.innerHTML = `${titles[scoreType] || scoreType} ìƒì„¸ ë¶„ì„`;
      
      // Generate content based on score type
      let content = '';
      
      if (scoreType === 'wealth') {
        const wealthLine = aux.wealthLine || {};
        const sunLine = aux.sunLine || {};
        
        content = `
          <div class="modal-section">
            <h3>ğŸ“ˆ 1. ë¶„ì„ ê·¼ê±° (ì •ëŸ‰ì  ì§€í‘œ)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${wealthLine.strength || 75}%</div>
                <div class="metric-label">ì¬ë¬¼ì„  ê°•ë„</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${sunLine.strength || 80}%</div>
                <div class="metric-label">íƒœì–‘ì„  ê°•ë„</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${wealthLine.triangles || 1}ê°œ</div>
                <div class="metric-label">ì‚¼ê° ë¬¸ì–‘</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${scores.wealth.sajuContribution}%</div>
                <div class="metric-label">ì‚¬ì£¼ ê¸°ì—¬ë„</div>
              </div>
            </div>
            <p style="margin-top:15px">
              <strong>êµ¬ë¦‰ ì˜í–¥:</strong> íƒœì–‘êµ¬(Apollo) ë°œë‹¬ë„ ${mounts.sun?.development || 85}% - ëª…ì„±ê³¼ ë¶€ì˜ ì—°ê´€ì„±<br>
              <strong>ATD ê°ë„:</strong> ${palm.dermatoglyphics?.atdAngle || 41}Â° - ì •ìƒ ë²”ìœ„
            </p>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ”® 2. ìƒì„¸ í•´ì„ (ìœµí•© ê²°ê³¼)</h3>
            <p>í˜„ì¬ ì¬ë¬¼ìš´ ì ìˆ˜ <strong>${scores.wealth.score}ì </strong>ì€ ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:</p>
            <ul>
              <li>ì¬ë¬¼ì„ ì˜ ${wealthLine.clarity || 'deep'} í˜•íƒœì™€ ${wealthLine.strength}% ê°•ë„ëŠ” ì•ˆì •ì ì¸ ì¬ë¬¼ ì¶•ì  ëŠ¥ë ¥ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
              <li>íƒœì–‘ì„  ${sunLine.strength}% ë°œë‹¬ì€ ëª…ì„±ì„ í†µí•œ ë¶€ì˜ ì°½ì¶œ ê°€ëŠ¥ì„±ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.</li>
              <li>${wealthLine.triangles > 0 ? `${wealthLine.triangles}ê°œì˜ ì‚¼ê° ë¬¸ì–‘ì€ ì‚¬ì—…/íˆ¬ì ì„±ê³µ ì‹ í˜¸ì…ë‹ˆë‹¤.` : 'ì¶”ê°€ ì¬ë¬¼ ë¬¸ì–‘ì€ ê´€ì°°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</li>
              <li>ì‚¬ì£¼ ${scores.wealth.sajuContribution}% ë³´ì¡°ë¡œ ${AppState.currentAge + 5}ì„¸ ê²½ ì¬ë¬¼ ì¦ê°€ ê¸°íšŒê°€ ì˜ˆìƒë©ë‹ˆë‹¤.</li>
            </ul>
            ${scores.stressLoad > 70 ? `<p>âš ï¸ ë†’ì€ <span class="score-link" onclick="showScoreModal('stressLoad')">ìŠ¤íŠ¸ë ˆìŠ¤ ë¶€í•˜(${scores.stressLoad}ì )</span>ê°€ ì¬ë¬¼ìš´ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>` : ''}
          </div>
          
          <div class="modal-section">
            <h3>ğŸ’¡ 3. ë§ì¶¤í˜• ì†”ë£¨ì…˜ (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">ğŸ“Š</span>
              <div>
                <strong>ë‹¨ê¸° ì „ëµ (3ê°œì›”):</strong><br>
                í˜„ê¸ˆíë¦„ ìµœì í™” - ìˆ˜ì…ì˜ ${Math.min(30, 10 + wealthLine.triangles * 5)}%ë¥¼ íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ì „í™˜
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">ğŸ’</span>
              <div>
                <strong>ì¤‘ê¸° ì „ëµ (6ê°œì›”):</strong><br>
                íƒœì–‘ì„  ê°•ë„ ${sunLine.strength}%ë¥¼ í™œìš©í•œ ê°œì¸ ë¸Œëœë”© ê°•í™” - SNS/í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì¶•
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">ğŸ¯</span>
              <div>
                <strong>ì¥ê¸° ì „ëµ (1ë…„):</strong><br>
                ${wealthLine.triangles > 0 ? 'ì‚¼ê° ë¬¸ì–‘ ì‹ í˜¸ì— ë”°ë¥¸ ì‚¬ì—…/ë¶€ì—… ì¤€ë¹„' : 'ì•ˆì •ì  ìì‚° ì¶•ì ì— ì§‘ì¤‘'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'career') {
        const fateLine = palm.fateLine || {};
        const sunLine = aux.sunLine || {};
        
        content = `
          <div class="modal-section">
            <h3>ğŸ“ˆ 1. ë¶„ì„ ê·¼ê±° (ì •ëŸ‰ì  ì§€í‘œ)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${fateLine.strength || 72}%</div>
                <div class="metric-label">ìš´ëª…ì„  ê°•ë„</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${sunLine.strength || 80}%</div>
                <div class="metric-label">íƒœì–‘ì„  ê°•ë„</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${aux.risingLines?.count || 2}ê°œ</div>
                <div class="metric-label">í–¥ìƒì„ </div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${mounts.jupiter?.development || 82}%</div>
                <div class="metric-label">ëª©ì„±êµ¬ ë°œë‹¬</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ”® 2. ìƒì„¸ í•´ì„ (ìœµí•© ê²°ê³¼)</h3>
            <p>í˜„ì¬ ì§ì—…ìš´ ì ìˆ˜ <strong>${scores.career.score}ì </strong>ì˜ ì˜ë¯¸:</p>
            <ul>
              <li>ìš´ëª…ì„  ${fateLine.strength}% ë°œë‹¬ë¡œ ì§ì—…ì  ì•ˆì •ì„±ê³¼ ì„±ì¥ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.</li>
              <li>ëª©ì„±êµ¬ ${mounts.jupiter?.development}% ë°œë‹¬ì€ ë¦¬ë”ì‹­ê³¼ ê´€ë¦¬ ëŠ¥ë ¥ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
              <li>${aux.risingLines?.count || 0}ê°œì˜ í–¥ìƒì„ ì€ ìŠ¹ì§„/ì´ì§ ê¸°íšŒë¥¼ ì‹œì‚¬í•©ë‹ˆë‹¤.</li>
            </ul>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ’¡ 3. ë§ì¶¤í˜• ì†”ë£¨ì…˜ (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">ğŸ¯</span>
              <div>
                <strong>ê²½ë ¥ ê°œë°œ:</strong><br>
                ëª©ì„±êµ¬ ë°œë‹¬ë„ë¥¼ í™œìš©í•œ ë¦¬ë”ì‹­ í¬ì§€ì…˜ ì¤€ë¹„ - íŒ€ ë¦¬ë”/ë§¤ë‹ˆì € ì—­ëŸ‰ ê°•í™”
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">ğŸ“š</span>
              <div>
                <strong>ìŠ¤í‚¬ í–¥ìƒ:</strong><br>
                ${aux.risingLines?.count > 1 ? 'í–¥ìƒì„  ì‹ í˜¸ì— ë”°ë¥¸ ì „ë¬¸ ìê²©ì¦ ì·¨ë“' : 'í˜„ ì§ë¬´ ì „ë¬¸ì„± ì‹¬í™”'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'love') {
        const heartLine = palm.heartLine || {};
        const marriageLine = aux.marriageLine || {};
        
        content = `
          <div class="modal-section">
            <h3>ğŸ“ˆ 1. ë¶„ì„ ê·¼ê±° (ì •ëŸ‰ì  ì§€í‘œ)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${heartLine.length || 82}%</div>
                <div class="metric-label">ê°ì •ì„  ê¸¸ì´</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${marriageLine.count || 1}ê°œ</div>
                <div class="metric-label">ê²°í˜¼ì„ </div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${mounts.venus?.development || 80}%</div>
                <div class="metric-label">ê¸ˆì„±êµ¬ ë°œë‹¬</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${heartLine.type || 'curved'}</div>
                <div class="metric-label">ê°ì •ì„  í˜•íƒœ</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ”® 2. ìƒì„¸ í•´ì„ (ìœµí•© ê²°ê³¼)</h3>
            <p>í˜„ì¬ ì• ì •ìš´ ì ìˆ˜ <strong>${scores.love.score}ì </strong>ì˜ ì˜ë¯¸:</p>
            <ul>
              <li>ê°ì •ì„  ${heartLine.type === 'curved' ? 'ê³¡ì„ í˜•' : 'ì§ì„ í˜•'}ì€ ${heartLine.type === 'curved' ? 'ê°ì„±ì ì´ê³  ì—´ì •ì ì¸' : 'ì´ì„±ì ì´ê³  ì•ˆì •ì ì¸'} ì—°ì•  ìŠ¤íƒ€ì¼ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
              <li>ê¸ˆì„±êµ¬ ${mounts.venus?.development}% ë°œë‹¬ì€ ë§¤ë ¥ê³¼ ì• ì • í‘œí˜„ë ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</li>
              <li>${marriageLine.count}ê°œì˜ ê²°í˜¼ì„ ì€ ${marriageLine.count === 1 ? 'ì•ˆì •ì ì¸ ê´€ê³„' : 'ë‹¤ì–‘í•œ ì¸ì—°'}ì„ ì•”ì‹œí•©ë‹ˆë‹¤.</li>
            </ul>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ’¡ 3. ë§ì¶¤í˜• ì†”ë£¨ì…˜ (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">ğŸ’•</span>
              <div>
                <strong>ê´€ê³„ ê°œì„ :</strong><br>
                ${heartLine.type === 'curved' ? 'ê°ì • í‘œí˜„ ì¡°ì ˆê³¼ ì•ˆì •ì„± í™•ë³´' : 'ê°ì„±ì  í‘œí˜„ë ¥ í–¥ìƒ ì—°ìŠµ'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'health') {
        const lifeLine = palm.lifeLine || {};
        const healthLine = aux.healthLine || {};
        
        content = `
          <div class="modal-section">
            <h3>ğŸ“ˆ 1. ë¶„ì„ ê·¼ê±° (ì •ëŸ‰ì  ì§€í‘œ)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${lifeLine.length || 84}%</div>
                <div class="metric-label">ìƒëª…ì„  ê¸¸ì´</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${lifeLine.depth || 'deep'}</div>
                <div class="metric-label">ìƒëª…ì„  ê¹Šì´</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${scores.resilience.score}ì </div>
                <div class="metric-label">íšŒë³µ íƒ„ë ¥ì„±</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${scores.stressLoad.score}ì </div>
                <div class="metric-label">ìŠ¤íŠ¸ë ˆìŠ¤ ë¶€í•˜</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ”® 2. ìƒì„¸ í•´ì„ (ìœµí•© ê²°ê³¼)</h3>
            <p>í˜„ì¬ ê±´ê°•ìš´ ì ìˆ˜ <strong>${scores.health.score}ì </strong>ì˜ ì˜ë¯¸:</p>
            <ul>
              <li>ìƒëª…ì„  ${lifeLine.length}% ê¸¸ì´ì™€ ${lifeLine.depth} ê¹Šì´ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ì²´ë ¥ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
              <li><span class="score-link" onclick="showScoreModal('resilience')">íšŒë³µ íƒ„ë ¥ì„± ${scores.resilience.score}ì </span>ì€ ${scores.resilience.score > 70 ? 'ë¹ ë¥¸ íšŒë³µë ¥' : 'íšŒë³µë ¥ ê°•í™” í•„ìš”'}ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
              <li><span class="score-link" onclick="showScoreModal('stressLoad')">ìŠ¤íŠ¸ë ˆìŠ¤ ë¶€í•˜ ${scores.stressLoad.score}ì </span>ì€ ${scores.stressLoad.score > 70 ? 'ì¦‰ê°ì ì¸ ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ í•„ìš”' : 'ì ì • ìˆ˜ì¤€'}ì…ë‹ˆë‹¤.</li>
            </ul>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ’¡ 3. ë§ì¶¤í˜• ì†”ë£¨ì…˜ (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">ğŸƒ</span>
              <div>
                <strong>ìš´ë™ ê³„íš:</strong><br>
                íšŒë³µ íƒ„ë ¥ì„± ${scores.resilience.score}ì  ê¸°ì¤€ â†’ ${scores.resilience.score > 70 ? 'ê³ ê°•ë„ ì¸í„°ë²Œ ìš´ë™ ê°€ëŠ¥' : 'ì €ê°•ë„ ìœ ì‚°ì†Œ ìš´ë™ ê¶Œì¥'}
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">ğŸ§˜</span>
              <div>
                <strong>ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬:</strong><br>
                ${scores.stressLoad.score > 70 ? 'ì¦‰ì‹œ ëª…ìƒ/í˜¸í¡ë²• ë„ì…, ì£¼ 3íšŒ ì´ìƒ' : 'ì˜ˆë°©ì  ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ ìœ ì§€'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'resilience') {
        const lifeLine = palm.lifeLine || {};
        const marsLower = mounts.mars_lower?.development || 0;
        const marsUpper = mounts.mars_upper?.development || 0;
        
        content = `
          <div class="modal-section">
            <h3>ğŸ“ˆ 1. ë¶„ì„ ê·¼ê±° (ì •ëŸ‰ì  ì§€í‘œ)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${lifeLine.length || 84}%</div>
                <div class="metric-label">ìƒëª…ì„  ê¸¸ì´</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${Math.max(marsLower, marsUpper)}%</div>
                <div class="metric-label">í™”ì„±êµ¬ ë°œë‹¬</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${aux.healthLine?.breaks ? 'ìˆìŒ' : 'ì—†ìŒ'}</div>
                <div class="metric-label">ê±´ê°•ì„  ë‹¨ì ˆ</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ”® 2. ìƒì„¸ í•´ì„ (ìœµí•© ê²°ê³¼)</h3>
            <p>í˜„ì¬ íšŒë³µ íƒ„ë ¥ì„± ì ìˆ˜ <strong>${scores.resilience.score}ì </strong>ì˜ ì˜ë¯¸:</p>
            <ul>
              <li>ìƒëª…ì„  ê¸¸ì´ ${lifeLine.length}%ëŠ” ê¸°ë³¸ ì²´ë ¥ê³¼ íšŒë³µë ¥ì˜ ê¸°ë°˜ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
              <li>í™”ì„±êµ¬ ë°œë‹¬ë„ ${Math.max(marsLower, marsUpper)}%ëŠ” ì‹ ì²´ì  í™œë ¥ê³¼ ì €í•­ë ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</li>
              <li>${aux.healthLine?.breaks ? 'ê±´ê°•ì„  ë‹¨ì ˆì€ íšŒë³µ ê³¼ì •ì—ì„œ ì£¼ì˜ê°€ í•„ìš”í•¨ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.' : 'ê±´ê°•ì„  ì—°ì†ì„±ì€ ì•ˆì •ì ì¸ íšŒë³µë ¥ì„ ì§€ì›í•©ë‹ˆë‹¤.'}</li>
            </ul>
            <p>ì—°ê´€ ì§€í‘œ: <span class="score-link" onclick="showScoreModal('health')">ê±´ê°•ìš´ ${scores.health.score}ì </span></p>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ’¡ 3. ë§ì¶¤í˜• ì†”ë£¨ì…˜ (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">ğŸ’ª</span>
              <div>
                <strong>ì²´ë ¥ ì¦ì§„:</strong><br>
                í™”ì„±êµ¬ ${Math.max(marsLower, marsUpper)}% ìˆ˜ì¤€ â†’ ${Math.max(marsLower, marsUpper) > 70 ? 'ê·¼ë ¥ ìš´ë™ ê°•í™”' : 'ê¸°ì´ˆ ì²´ë ¥ êµ¬ì¶• ìš°ì„ '}
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">ğŸ›Œ</span>
              <div>
                <strong>íšŒë³µ ìµœì í™”:</strong><br>
                ìˆ˜ë©´ ì‹œê°„ ${scores.resilience.score > 70 ? '7ì‹œê°„' : '8ì‹œê°„'} í™•ë³´, íšŒë³µ ë³´ì¡°ì œ ê³ ë ¤
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'stressLoad') {
        const interferingLines = aux.interferingLines || {};
        
        content = `
          <div class="modal-section">
            <h3>ğŸ“ˆ 1. ë¶„ì„ ê·¼ê±° (ì •ëŸ‰ì  ì§€í‘œ)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${interferingLines.visible ? 'ìˆìŒ' : 'ì—†ìŒ'}</div>
                <div class="metric-label">ê°„ì„­ì„ </div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${interferingLines.count || 0}ê°œ</div>
                <div class="metric-label">ê°„ì„­ì„  ìˆ˜</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${lifeLine.breaks || 0}ê°œ</div>
                <div class="metric-label">ìƒëª…ì„  ë‹¨ì ˆ</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${palm.mountColors?.venus === '#ff9999' ? 'ë¶‰ìŒ' : 'ì •ìƒ'}</div>
                <div class="metric-label">êµ¬ë¦‰ ìƒ‰ì¡°</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ”® 2. ìƒì„¸ í•´ì„ (ìœµí•© ê²°ê³¼)</h3>
            <p>í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ë¶€í•˜ ì ìˆ˜ <strong>${scores.stressLoad.score}ì </strong>ì˜ ì˜ë¯¸:</p>
            <ul>
              <li>${interferingLines.visible ? `${interferingLines.count}ê°œì˜ ê°„ì„­ì„ ì€ í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸ì´ í™œì„±í™”ë˜ì–´ ìˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.` : 'ê°„ì„­ì„ ì´ ì—†ì–´ ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€ì´ ì–‘í˜¸í•©ë‹ˆë‹¤.'}</li>
              <li>${lifeLine.breaks > 0 ? 'ìƒëª…ì„  ë‹¨ì ˆì€ ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ ì¸í•œ ì—ë„ˆì§€ ì†Œëª¨ë¥¼ ì‹œì‚¬í•©ë‹ˆë‹¤.' : 'ìƒëª…ì„ ì´ ì—°ì†ì ì´ì–´ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ ëŒ€ì²˜ë ¥ì´ ì•ˆì •ì ì…ë‹ˆë‹¤.'}</li>
            </ul>
            <p>ì—°ê´€ ì§€í‘œ: <span class="score-link" onclick="showScoreModal('resilience')">íšŒë³µ íƒ„ë ¥ì„± ${scores.resilience.score}ì </span>, <span class="score-link" onclick="showScoreModal('health')">ê±´ê°•ìš´ ${scores.health.score}ì </span></p>
          </div>
          
          <div class="modal-section">
            <h3>ğŸ’¡ 3. ë§ì¶¤í˜• ì†”ë£¨ì…˜ (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">ğŸ§˜</span>
              <div>
                <strong>ì¦‰ì‹œ ì‹¤í–‰:</strong><br>
                ${scores.stressLoad.score > 70 ? 'í•˜ë£¨ 3íšŒ ì‹¬í˜¸í¡(4-7-8 í˜¸í¡ë²•), ì£¼ 3íšŒ ëª…ìƒ ì•± ì‚¬ìš©' : 'ì˜ˆë°©ì  ìŠ¤íŠ¸ë ˆìŠ¤ ê´€ë¦¬ ìœ ì§€'}
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">ğŸ“</span>
              <div>
                <strong>ìŠ¤íŠ¸ë ˆìŠ¤ ì›ì¸ ê´€ë¦¬:</strong><br>
                ${interferingLines.count > 1 ? 'ë‹¤ì¤‘ ìŠ¤íŠ¸ë ˆìŠ¤ ì›ì¸ â†’ ìš°ì„ ìˆœìœ„ ì„¤ì • í›„ ë‹¨ê³„ì  í•´ê²°' : 'ë‹¨ì¼ ìŠ¤íŠ¸ë ˆìŠ¤ ì›ì¸ ì§‘ì¤‘ í•´ê²°'}
              </div>
            </div>
          </div>
        `;
      }
      
      body.innerHTML = DOMPurify.sanitize(content);
      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('score-modal').classList.remove('active');
    }

    // Close modal on outside click
    document.getElementById('score-modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // UTILS
    async function fetchWithTimeout(resource, options={}, timeout=15000){
      const controller = new AbortController(); const id=setTimeout(()=>controller.abort(), timeout);
      try{
        const res=await fetch(resource,{...options,signal:controller.signal});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const ct=res.headers.get("content-type")||"";
        return ct.includes("application/json")?await res.json():await res.text();
      } finally{ clearTimeout(id); }
    }

    function cap01(x){ return Math.max(0,Math.min(1,x)); }
    function avgQuality01(){ const l=AppState.palmImages.quality.left?.score, r=AppState.palmImages.quality.right?.score; const arr=[l,r].filter(v=>typeof v==='number'); return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length/100:0.5; }

    // Image Quality Evaluation
    async function evaluateImageQuality(dataUrl){
      const img=await new Promise((res)=>{ const i=new Image(); i.onload=()=>res(i); i.src=dataUrl; });
      const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
      canvas.width=256; canvas.height=256; ctx.drawImage(img,0,0,256,256);
      const data=ctx.getImageData(0,0,256,256).data;
      
      let brightness=0; for(let i=0;i<data.length;i+=4){ brightness+=0.34*data[i]+0.5*data[i+1]+0.16*data[i+2]; }
      brightness=brightness/(256*256);
      
      const score=Math.round(70+(brightness-128)*0.3+Math.random()*10);
      return {score:Math.max(30,Math.min(95,score)), brightness:Math.round(brightness)};
    }

    // Hand Shape Classification
    async function classifyHandShapeHeuristic(dataUrl, quality){
      const img = await new Promise((res)=>{ const i=new Image(); i.onload=()=>res(i); i.src=dataUrl; });
      const ar = img.height / img.width;
      const edge = quality?.edgeDensity ?? 0.12;
      let type='Air';
      if(ar>1.2 && edge<0.15) type='Water';
      else if(Math.abs(ar-1.0)<0.15 && edge>=0.1) type='Earth';
      else if(edge>0.18) type='Fire';
      const elem = {Fire:'ç«',Earth:'åœŸ',Air:'é¢¨',Water:'æ°´'}[type]||'é¢¨';
      const weights = {
        Fire:  {career:+4, wealth:+2, love:+3, health:-1},
        Earth: {career:+2, wealth:+3, love:+1, health:+3},
        Air:   {career:+3, wealth:+2, love:+2, health:+1},
        Water: {career:+1, wealth:+1, love:+3, health:-1}
      }[type]||{career:0,wealth:0,love:0,health:0};
      return {type, element:elem, weights};
    }

    // Scientific Scores
    function computeResilienceScore(palm){
      const ll = palm?.lifeLine?.length ?? 70;
      const marsDev = Math.max(palm?.mounts?.mars_lower?.development||0, palm?.mounts?.mars_upper?.development||0);
      let score = 40 + (ll-70)*0.4 + (marsDev-60)*0.2;
      if(palm?.auxiliaryLines?.healthLine?.breaks) score -= 10;
      return Math.max(0,Math.min(100,Math.round(score)));
    }

    function computeStressLoadScore(palm){
      let s = 50;
      const inter = palm?.auxiliaryLines?.interferingLines;
      if(inter?.visible) s += 8 + (inter.count||1)*2;
      if(palm?.lifeLine?.breaks) s += 8;
      return Math.max(0,Math.min(100,Math.round(s)));
    }

    // Stub Analysis
    class SajuCalculator {
      async calculate(y,m,d,h,g,isLunar){
        return {degraded:true, pillars:null, pattern:null, fiveElements:{'æœ¨':20,'ç«':25,'åœŸ':18,'é‡‘':20,'æ°´':17}};
      }
    }

    class InferenceClient {
      static async run(dataUrl, progress){
        return {
          handShape: {type:'Fire', element:'ç«', weights:{career:+4, wealth:+2, love:+3, health:-1}},
          lifeLine:{length:85, breaks:0, type:'curved', depth:'deep'},
          headLine:{length:78, type:'straight'},
          heartLine:{length:82, type:'curved'},
          fateLine:{visible:true, strength:72},
          auxiliaryLines:{
            sunLine:{visible:true, strength:80, contribution:25},
            wealthLine:{visible:true, strength:78, triangles:2, clarity:'deep', contribution:30},
            interferingLines:{visible:true, count:1, contribution:-8},
            marriageLine:{visible:true, count:1, clarity:'clear'},
            healthLine:{visible:true, breaks:0},
            risingLines:{count:2}
          },
          mounts:{jupiter:{development:82}, saturn:{development:70}, sun:{development:88}, mercury:{development:75}, venus:{development:80}, moon:{development:74}, mars_lower:{development:78}, mars_upper:{development:70}},
          mountColors:{venus:'#ffcccc'},
          dermatoglyphics:{atdAngle:41},
          accuracy:0.92
        };
      }
    }

    // Analyzer
    class AdvancedPalmAnalyzer{
      async analyzePalm(imageData, progress){
        const api = await InferenceClient.run(imageData, progress);
        return api;
      }
    }

    // Scoring
    function calculateScoresV3(palmResults, sajuResults, handShape){
      const palm = palmResults.left || palmResults.right;
      const aux = palm?.auxiliaryLines || {};
      
      let wealth=50, career=50, health=50, love=50;
      
      if(handShape?.weights){
        career += handShape.weights.career;
        wealth += handShape.weights.wealth;
        love += handShape.weights.love;
        health += handShape.weights.health;
      }
      
      if(palm?.fateLine?.visible) career += (palm.fateLine.strength||60)*0.35;
      if(palm?.lifeLine) health += (palm.lifeLine.length||70)*0.30;
      if(palm?.heartLine) love += (palm.heartLine.length||70)*0.28;
      if(aux?.sunLine?.visible) career += (aux.sunLine.contribution ?? 20);
      if(aux?.wealthLine?.visible) wealth += (aux.wealthLine.contribution ?? 25);
      if(aux?.marriageLine?.visible) love += 6;
      if(aux?.healthLine?.visible) health += aux.healthLine.breaks? -6 : +3;
      if(aux?.risingLines?.count) career += Math.min(8, aux.risingLines.count*3);
      if(aux?.interferingLines?.visible){ wealth -= 8; career -= 8; }
      
      const resilience = computeResilienceScore(palm);
      const stressLoad = computeStressLoadScore(palm);
      
      const cap=v=>Math.max(0,Math.min(100,Math.round(v)));
      wealth=cap(wealth); career=cap(career); health=cap(health); love=cap(love);
      const total = Math.round((wealth+career+health+love)/4);
      
      return {
        total, confidence:85,
        wealth:{score:wealth, palmContribution:80, sajuContribution:20},
        career:{score:career, palmContribution:80, sajuContribution:20},
        health:{score:health, palmContribution:80, sajuContribution:20},
        love:{score:love, palmContribution:80, sajuContribution:20},
        resilience:{score:resilience}, 
        stressLoad:{score:stressLoad}
      };
    }

    // Integration
    class IntegratedAnalysisEngine{
      constructor(){
        this.palmAnalyzer = new AdvancedPalmAnalyzer();
        this.sajuCalc = new SajuCalculator();
      }
      
      async analyze(palmImages, sajuData, progress){
        progress?.(10,'ì†ê¸ˆ ë¶„ì„...');
        const palms = {};
        if(palmImages.left) palms.left = await this.palmAnalyzer.analyzePalm(palmImages.left);
        if(palmImages.right) palms.right = await this.palmAnalyzer.analyzePalm(palmImages.right);
        
        const palm = palms.right || palms.left;
        const handShape = await classifyHandShapeHeuristic(palmImages.right || palmImages.left, AppState.palmImages.quality.right || AppState.palmImages.quality.left);
        
        progress?.(62,'ì‚¬ì£¼ ë³´ì¡° ë¶„ì„...');
        const saju = await this.sajuCalc.calculate(sajuData.year, sajuData.month, sajuData.day, sajuData.hour, sajuData.gender, sajuData.isLunar);
        
        progress?.(82,'í†µí•© ìŠ¤ì½”ì–´ë§...');
        const scores = calculateScoresV3(palms, saju, handShape);
        
        progress?.(100,'ì™„ë£Œ');
        return {scores, palmResults:palms, sajuResults:saju, handShape};
      }
    }

    // UI Functions
    function updateStepUI(){
      document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active'));
      document.getElementById(`step${AppState.currentStep}`).classList.add('active');
      document.querySelectorAll('.step').forEach((s,i)=>{
        s.classList.remove('active','completed');
        if(i+1===AppState.currentStep) s.classList.add('active');
        else if(i+1<AppState.currentStep) s.classList.add('completed');
      });
      document.querySelector('.progress-fill').style.width = `${(AppState.currentStep/4)*100}%`;
    }

    function nextStep(){
      if(AppState.currentStep===1){
        if(!AppState.palmImages.left && !AppState.palmImages.right){ alert('ìµœì†Œ í•œ ì†ì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.'); return; }
      }else if(AppState.currentStep===2){
        if(!validateSajuForm()) return; 
        saveSajuData();
      }
      if(AppState.currentStep<4){ AppState.currentStep++; updateStepUI(); }
    }

    function previousStep(){ if(AppState.currentStep>1){ AppState.currentStep--; updateStepUI(); } }

    function validateSajuForm(){
      const get=(id)=>document.getElementById(id);
      const y=+get('birth-year').value, m=+get('birth-month').value, d=+get('birth-day').value;
      const g=get('gender').value;
      let ok=true;
      if(!y||y<1900||y>2100) ok=false;
      if(!m||m<1||m>12) ok=false;
      if(!d||d<1||d>31) ok=false;
      if(!g) ok=false;
      return ok;
    }

    function saveSajuData(){
      const get=(id)=>document.getElementById(id);
      AppState.sajuData = {
        year:+get('birth-year').value,
        month:+get('birth-month').value,
        day:+get('birth-day').value,
        hour:+get('birth-hour').value,
        gender:get('gender').value,
        isLunar:get('lunar-calendar').checked
      };
      const today=new Date();
      const birth=new Date(AppState.sajuData.year, AppState.sajuData.month-1, AppState.sajuData.day);
      AppState.currentAge = today.getFullYear()-birth.getFullYear();
    }

    // Image Upload
    async function handleImageUpload(file, hand){
      if(!file) return;
      const reader=new FileReader();
      reader.onload=async e=>{
        const data=e.target.result;
        const q = await evaluateImageQuality(data);
        AppState.palmImages[hand]=data;
        AppState.palmImages.quality[hand]=q;
        updateImagePreview(hand, data, q);
      };
      reader.readAsDataURL(file);
    }

    function updateImagePreview(hand, dataUrl, quality){
      const preview=document.getElementById(`${hand}-preview`);
      const badge=document.getElementById(`${hand}-quality`);
      const card=document.getElementById(`${hand}-upload`);
      preview.src=dataUrl; preview.classList.add('visible'); card.classList.add('has-image');
      let cls='quality-low', txt='ë‚®ìŒ';
      if(quality.score>=82){ cls='quality-high'; txt='ë†’ìŒ'; } 
      else if(quality.score>=70){ cls='quality-medium'; txt='ë³´í†µ'; }
      badge.className=`quality-badge ${cls}`; 
      badge.textContent=`í’ˆì§ˆ: ${txt} (${quality.score}/100)`;
    }

    // Analysis
    async function startAnalysis(){
      if(!(AppState.palmImages.left||AppState.palmImages.right)) return;
      document.getElementById('loading').classList.add('active');
      
      try{
        const engine = new IntegratedAnalysisEngine();
        const progress=(p,msg)=>{
          document.getElementById('loading-percentage').textContent=`${Math.round(p)}%`;
          document.getElementById('loading-text').textContent=msg||'ë¶„ì„ ì¤‘...';
          document.getElementById('loading-progress-bar').style.width=`${p}%`;
        };
        
        const res = await engine.analyze(AppState.palmImages, AppState.sajuData, progress);
        AppState.analysisResults = res;
        AppState.currentStep = 4;
        updateStepUI();
        renderResults(res);
      }catch(err){
        console.error(err);
        alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }finally{
        document.getElementById('loading').classList.remove('active');
      }
    }

    function cancelAnalysis(){ document.getElementById('loading').classList.remove('active'); }

    // Render Results with Clickable Cards
    function renderResults(r){
      const grid=document.getElementById('result-grid');
      const detail=document.getElementById('detailed-result');
      const W=r.scores.wealth, C=r.scores.career, L=r.scores.love, H=r.scores.health;
      
      grid.innerHTML=`
        <div class="result-card"><div class="result-score">${r.scores.total}</div><div class="result-sub">ì¢…í•© ì ìˆ˜</div></div>
        <div class="result-card clickable" onclick="showScoreModal('wealth')"><div class="result-score">${W.score}</div><div class="result-sub">ì¬ë¬¼ìš´ Â· ${W.palmContribution}/${W.sajuContribution}%</div></div>
        <div class="result-card clickable" onclick="showScoreModal('career')"><div class="result-score">${C.score}</div><div class="result-sub">ì§ì—…ìš´ Â· ${C.palmContribution}/${C.sajuContribution}%</div></div>
        <div class="result-card clickable" onclick="showScoreModal('love')"><div class="result-score">${L.score}</div><div class="result-sub">ì• ì •ìš´ Â· ${L.palmContribution}/${L.sajuContribution}%</div></div>
        <div class="result-card clickable" onclick="showScoreModal('health')"><div class="result-score">${H.score}</div><div class="result-sub">ê±´ê°•ìš´</div></div>
        <div class="result-card clickable" onclick="showScoreModal('resilience')"><div class="result-score">${r.scores.resilience?.score ?? '-'}</div><div class="result-sub">íšŒë³µ íƒ„ë ¥ì„±</div></div>
        <div class="result-card clickable" onclick="showScoreModal('stressLoad')"><div class="result-score">${r.scores.stressLoad?.score ?? '-'}</div><div class="result-sub">ìŠ¤íŠ¸ë ˆìŠ¤ ë¶€í•˜</div></div>
        <div class="result-card"><div class="result-score">${r.scores.confidence||80}%</div><div class="result-sub">ì‹ ë¢°ë„</div></div>
      `;
      
      detail.innerHTML = `
        <div class="expert-card">
          <h3>ğŸ“Š ë¶„ì„ ê°œìš”</h3>
          <p><strong>í˜„ì¬ ë‚˜ì´:</strong> ${AppState.currentAge}ì„¸</p>
          <p><strong>ì† í˜•íƒœ:</strong> ${r.handShape?.type} (${r.handShape?.element})</p>
          <p style="margin-top:12px;color:#666">ğŸ’¡ ìŠ¤ì½”ì–´ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ë¶„ì„ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      `;
    }

    // Export Functions
    function exportResults(){ window.print(); }
    function exportCSV(){ 
      const r=AppState.analysisResults; 
      if(!r) return;
      const rows=[['í•­ëª©','ì ìˆ˜'],['ì¢…í•©',r.scores.total],['ì¬ë¬¼',r.scores.wealth.score],['ì§ì—…',r.scores.career.score],['ì• ì •',r.scores.love.score],['ê±´ê°•',r.scores.health.score],['íšŒë³µíƒ„ë ¥ì„±',r.scores.resilience.score],['ìŠ¤íŠ¸ë ˆìŠ¤ë¶€í•˜',r.scores.stressLoad.score]];
      const csv=rows.map(r=>r.join(',')).join('\n');
      const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); 
      a.href=URL.createObjectURL(blob); 
      a.download='PalmAI_Results.csv'; 
      a.click();
    }
    function exportToSheets(){ exportCSV(); alert('CSV íŒŒì¼ì„ Google Sheetsì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.'); }

    // UI Handlers
    function openGuide(){ document.getElementById('guide').classList.add('active'); }
    function closeGuide(){ document.getElementById('guide').classList.remove('active'); }
    function showPrivacyInfo(){ document.getElementById('privacy-modal').classList.add('active'); }
    function closePrivacyModal(){ document.getElementById('privacy-modal').classList.remove('active'); }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.step').forEach(s=>{ s.addEventListener('click',()=>{ const n=+s.dataset.step; if(n<=AppState.currentStep){ AppState.currentStep=n; updateStepUI(); } }); });
      document.getElementById('left-upload').addEventListener('click',()=>document.getElementById('left-hand-input').click());
      document.getElementById('right-upload').addEventListener('click',()=>document.getElementById('right-hand-input').click());
      document.getElementById('left-hand-input').addEventListener('change',e=>handleImageUpload(e.target.files[0],'left'));
      document.getElementById('right-hand-input').addEventListener('change',e=>handleImageUpload(e.target.files[0],'right'));
    });
  </script>
</body>
</html>