<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PalmAI Pro - v9.2 (Interactive Modal Edition)</title>
  <style>
    :root{
      --primary:#6a11cb;--secondary:#2575fc;--success:#00b894;--danger:#d63031;--warning:#fdcb6e;
      --dark:#2d3436;--light:#f5f6fa;--text:#2c3e50;--border:#dfe6e9;--shadow:0 5px 20px rgba(0,0,0,.1);
      --transition:all .3s cubic-bezier(.4,0,.2,1)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans KR',sans-serif;background:linear-gradient(135deg,var(--primary),var(--secondary));min-height:100vh;color:var(--text);line-height:1.6}
    .main-container{max-width:1200px;margin:0 auto;padding:20px}
    .app-header{color:#fff;text-align:center;padding:40px 20px}
    .app-header h1{font-size:2.2rem;margin-bottom:8px;text-shadow:2px 2px 6px rgba(0,0,0,.25)}
    .step-navigation{background:#fff;border-radius:18px;padding:22px;margin-bottom:22px;box-shadow:var(--shadow)}
    .steps{display:flex;justify-content:space-between;position:relative;margin-bottom:16px}
    .steps:before{content:'';position:absolute;left:0;right:0;top:20px;height:2px;background:var(--border)}
    .step{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;z-index:1}
    .step-number{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;background:var(--light);border:2px solid var(--border)}
    .step.active .step-number{background:var(--primary);color:#fff;border-color:var(--primary);transform:scale(1.1)}
    .step.completed .step-number{background:var(--success);color:#fff;border-color:var(--success)}
    .step-label{font-size:.9rem}
    .progress-bar{height:8px;background:var(--border);border-radius:10px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(135deg,var(--primary),var(--secondary));width:25%;transition:width .5s}
    .content-area{background:#fff;border-radius:18px;padding:22px;box-shadow:var(--shadow);min-height:520px}
    .step-content{display:none}.step-content.active{display:block}
    .upload-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin:20px 0}
    .upload-card{border:3px dashed var(--border);border-radius:16px;padding:32px 18px;text-align:center;cursor:pointer;position:relative;background:var(--light);transition:var(--transition)}
    .upload-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}
    .upload-card.has-image{border-style:solid;border-color:var(--success)}
    .upload-icon{font-size:2.6rem;margin-bottom:10px}
    .upload-preview{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:12px;opacity:0;transition:opacity .3s}
    .upload-preview.visible{opacity:1}
    .quality-badge{position:absolute;top:10px;right:10px;padding:6px 12px;border-radius:20px;font-size:.85rem;font-weight:700;color:#fff;z-index:2}
    .quality-high{background:var(--success)}.quality-medium{background:var(--warning)}.quality-low{background:var(--danger)}
    .saju-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:18px 0}
    .form-control{padding:12px;border:2px solid var(--border);border-radius:10px;font-size:1rem}
    .form-control.error{border-color:var(--danger)}
    .error-message{display:none;color:var(--danger);font-size:.85rem;margin-top:6px}
    .error-message.show{display:block}
    .btn{padding:12px 24px;border:none;border-radius:10px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
    .btn-secondary{background:var(--light);border:2px solid var(--border)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-group{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:16px}
    .analysis-progress{margin:20px 0}
    .analysis-step{padding:14px;margin:10px 0;background:var(--light);border-left:4px solid var(--primary);display:flex;justify-content:space-between;align-items:center}
    .analysis-step.completed{border-left-color:var(--success);background:rgba(0,184,148,.08)}
    .analysis-step.error{border-left-color:var(--danger);background:rgba(214,48,49,.08)}
    .progress-percentage{font-weight:800;color:var(--primary)}
    .result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin:18px 0}
    .result-card{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:18px 16px;border-radius:16px;text-align:center;white-space:nowrap;transition:all .3s;position:relative;overflow:hidden}
    .result-card.clickable{cursor:pointer}
    .result-card.clickable:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(106,17,203,.3)}
    .result-card.clickable:hover::after{content:'📊 상세보기';position:absolute;bottom:8px;right:8px;font-size:.75rem;opacity:.9}
    .result-score{font-size:2.1rem;font-weight:900}
    .result-card .result-sub{font-size:.9rem;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .expert-card{background:#fff;border-left:5px solid var(--primary);border-radius:12px;padding:18px;margin:14px 0;box-shadow:var(--shadow)}
    .banner{padding:10px 14px;border-radius:10px;margin:10px 0;font-size:.95rem}
    .banner.warn{background:#fff7e6;border:1px solid #ffd591}
    .banner.error{background:#ffecec;border:1px solid #ffb3b3}
    .guide-list li{margin-left:18px}
    #palm-canvas{max-width:100%;border-radius:12px;border:2px solid var(--border);margin-top:10px;background:#f8fafc}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:9999}
    .overlay.active{display:flex}
    .overlay-card{background:#fff;color:#222;border-radius:14px;padding:20px;max-width:720px;width:92%;max-height:85vh;overflow-y:auto}
    .loading-spinner{width:56px;height:56px;border:4px solid rgba(0,0,0,.12);border-top-color:#6a11cb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
    .loading-progress{width:220px;height:6px;background:rgba(0,0,0,.1);border-radius:3px;margin:10px auto;overflow:hidden}
    .loading-progress-bar{height:100%;background:#6a11cb;width:0%;transition:width .3s}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Modal Styles */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:10000;backdrop-filter:blur(5px)}
    .modal-overlay.active{display:flex}
    .modal-content{background:#fff;border-radius:20px;max-width:680px;width:92%;max-height:85vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:modalSlide .3s ease}
    @keyframes modalSlide{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:20px 25px;position:relative}
    .modal-header h2{font-size:1.5rem;display:flex;align-items:center;gap:12px}
    .modal-close{position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.2);border:none;color:#fff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;transition:.2s}
    .modal-close:hover{background:rgba(255,255,255,.3)}
    .modal-body{padding:25px;overflow-y:auto;max-height:60vh}
    .modal-section{margin-bottom:25px;padding:20px;background:#f8f9fa;border-radius:12px;border-left:4px solid var(--primary)}
    .modal-section h3{color:var(--primary);margin-bottom:12px;font-size:1.1rem}
    .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:15px 0}
    .metric-box{background:#fff;padding:12px;border-radius:8px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .metric-value{font-size:1.8rem;font-weight:bold;color:var(--primary)}
    .metric-label{font-size:.85rem;color:#666;margin-top:4px}
    .action-item{display:flex;align-items:start;gap:12px;margin:12px 0;padding:10px;background:#fff;border-radius:8px}
    .action-icon{font-size:1.2rem;margin-top:2px}
    .score-link{color:var(--primary);text-decoration:underline;cursor:pointer;font-weight:600}
    .score-link:hover{color:var(--secondary)}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.7/purify.min.js"></script>
</head>
<body>
  <header class="app-header">
    <h1>🖐️ PalmAI Pro v9.2</h1>
    <p>손의 형태·손금 전요소·구릉·문양·색상 + 사주 보조 + 과학·의학 참고</p>
  </header>

  <main class="main-container">
    <nav class="step-navigation">
      <div class="steps">
        <div class="step active" data-step="1"><div class="step-number">1</div><div class="step-label">손금 업로드</div></div>
        <div class="step" data-step="2"><div class="step-number">2</div><div class="step-label">사주 입력</div></div>
        <div class="step" data-step="3"><div class="step-number">3</div><div class="step-label">AI 분석</div></div>
        <div class="step" data-step="4"><div class="step-number">4</div><div class="step-label">결과</div></div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:25%"></div></div>
    </nav>

    <div class="content-area">
      <section class="step-content active" id="step1">
        <h2>손금 사진 업로드 (필수)</h2>
        <div class="banner warn"><strong>Tip:</strong> 두 손 모두 올릴수록 정확도가 올라갑니다.</div>
        <div class="btn-group" style="justify-content:flex-start">
          <button class="btn btn-secondary" onclick="openGuide()">📸 촬영 가이드</button>
          <button class="btn btn-secondary" onclick="showPrivacyInfo()">🔒 개인정보</button>
        </div>
        <div class="upload-grid">
          <div class="upload-card" id="left-upload">
            <input type="file" id="left-hand-input" accept="image/*" capture="environment" style="display:none"/>
            <div class="upload-icon">🤚</div>
            <h3>왼손 (선천운)</h3>
            <p>클릭하여 업로드</p>
            <img class="upload-preview" id="left-preview" alt="왼손 미리보기"/>
            <div class="quality-badge" id="left-quality"></div>
          </div>
          <div class="upload-card" id="right-upload">
            <input type="file" id="right-hand-input" accept="image/*" capture="environment" style="display:none"/>
            <div class="upload-icon">🖐️</div>
            <h3>오른손 (후천운)</h3>
            <p>클릭하여 업로드</p>
            <img class="upload-preview" id="right-preview" alt="오른손 미리보기"/>
            <div class="quality-badge" id="right-quality"></div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="nextStep()">다음 단계</button>
        </div>
      </section>

      <section class="step-content" id="step2">
        <h2>사주 정보 입력 (보조)</h2>
        <div id="saju-warning"></div>
        <form class="saju-form" id="saju-form">
          <div>
            <label for="birth-year">생년</label>
            <input type="number" class="form-control" id="birth-year" min="1900" max="2100" required/>
            <div class="error-message" id="year-error"></div>
          </div>
          <div>
            <label for="birth-month">생월</label>
            <input type="number" class="form-control" id="birth-month" min="1" max="12" required/>
            <div class="error-message" id="month-error"></div>
          </div>
          <div>
            <label for="birth-day">생일</label>
            <input type="number" class="form-control" id="birth-day" min="1" max="31" required/>
            <div class="error-message" id="day-error"></div>
          </div>
          <div>
            <label for="birth-hour">생시</label>
            <select class="form-control" id="birth-hour">
              <option value="-1">모름</option>
              <option value="0">자(23-01)</option><option value="2">축(01-03)</option><option value="4">인(03-05)</option>
              <option value="6">묘(05-07)</option><option value="8">진(07-09)</option><option value="10">사(09-11)</option>
              <option value="12">오(11-13)</option><option value="14">미(13-15)</option><option value="16">신(15-17)</option>
              <option value="18">유(17-19)</option><option value="20">술(19-21)</option><option value="22">해(21-23)</option>
            </select>
          </div>
          <div>
            <label for="gender">성별</label>
            <select class="form-control" id="gender" required>
              <option value="">선택</option><option value="male">남성</option><option value="female">여성</option>
            </select>
            <div class="error-message" id="gender-error"></div>
          </div>
          <div>
            <label for="lunar-calendar">음력(윤달 포함)</label>
            <input type="checkbox" id="lunar-calendar"/>
          </div>
        </form>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previousStep()">이전</button>
          <button class="btn btn-primary" onclick="nextStep()">다음</button>
        </div>
      </section>

      <section class="step-content" id="step3">
        <h2>AI 분석 진행</h2>
        <div class="analysis-progress">
          <div class="analysis-step" id="palm-detection"><span>손금선/문양/형태 검출...</span><span class="progress-percentage">0%</span></div>
          <div class="analysis-step" id="saju-calculation"><span>사주 보조 분석...</span><span class="progress-percentage">0%</span></div>
          <div class="analysis-step" id="integration"><span>통합 스코어링...</span><span class="progress-percentage">0%</span></div>
        </div>
        <canvas id="palm-canvas" width="960" height="640"></canvas>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previousStep()">이전</button>
          <button class="btn btn-primary" id="analysis-button" onclick="startAnalysis()">분석 시작</button>
          <button class="btn btn-danger" id="cancel-button" onclick="cancelAnalysis()" style="display:none">분석 취소</button>
        </div>
      </section>

      <section class="step-content" id="step4">
        <h2>종합 결과</h2>
        <div id="global-banners"></div>
        <div class="result-grid" id="result-grid"></div>
        <div class="detailed-result" id="detailed-result"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="exportResults()">PDF</button>
          <button class="btn btn-secondary" onclick="exportCSV()">CSV</button>
          <button class="btn btn-primary" onclick="exportToSheets()">Sheets로 내보내기</button>
        </div>
      </section>
    </div>
  </main>

  <!-- Score Detail Modal -->
  <div class="modal-overlay" id="score-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">📊 재물운 상세 분석</h2>
        <button class="modal-close" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="overlay" id="loading">
    <div class="overlay-card" style="max-width:420px">
      <div class="loading-spinner"></div>
      <div id="loading-text" style="text-align:center">분석 중...</div>
      <div class="loading-progress"><div class="loading-progress-bar" id="loading-progress-bar"></div></div>
      <div id="loading-percentage" style="text-align:center">0%</div>
      <div class="btn-group" style="justify-content:center;margin-top:10px">
        <button class="btn btn-danger" onclick="cancelAnalysis()">분석 취소</button>
      </div>
    </div>
  </div>

  <!-- Guide Modal -->
  <div class="overlay" id="guide">
    <div class="overlay-card">
      <h3 style="margin-bottom:10px;color:var(--primary)">📸 손금 촬영 가이드</h3>
      <ul class="guide-list">
        <li><strong>밝은 단색 배경</strong> 위에서 촬영 (흰색 천/종이 추천)</li>
        <li>손바닥을 <strong>완전히 펴고</strong>, 손가락은 <strong>과도하게 모으지 않기</strong></li>
        <li><strong>플래시/강한 조명</strong>으로 선의 명암 대비 확보, 그림자 최소화</li>
        <li>손 전체가 프레임에 들어오도록, <strong>화면 80% 이상</strong> 채우기</li>
        <li>카메라는 손에서 <strong>약 25~35cm</strong> 거리, 흔들림 방지</li>
      </ul>
      <div class="btn-group" style="justify-content:flex-end;margin-top:12px"><button class="btn btn-primary" onclick="closeGuide()">확인</button></div>
    </div>
  </div>

  <!-- Privacy Modal -->
  <div class="overlay" id="privacy-modal">
    <div class="overlay-card" style="max-width:560px">
      <h3 style="margin-bottom:10px;color:var(--primary)">🔒 개인정보 보호 안내</h3>
      <ul>
        <li>모든 데이터는 암호화되어 로컬에 저장됩니다.</li>
        <li>서버 통신 시 SSL/TLS를 사용합니다.</li>
        <li>분석 후 원본 이미지는 즉시 삭제됩니다.</li>
        <li>언제든지 데이터 삭제를 요청할 수 있습니다.</li>
      </ul>
      <p style="margin-top:10px"><strong>주의:</strong> 본 서비스는 오락 및 참고용이며, 의료·법률 조언이 아닙니다.</p>
      <div class="btn-group" style="justify-content:flex-end;margin-top:12px"><button class="btn btn-primary" onclick="closePrivacyModal()">확인</button></div>
    </div>
  </div>

  <script>
    // CONFIG
    const PalmAI_CONFIG = {
      BACKEND_BASE: "https://api.yourdomain.com",
      ENDPOINTS: { SAJU: "/saju/calculate", INFER: "/palm/infer", FEEDBACK:"/feedback" },
      FEATURES: { useBackendSaju: true, requireSaju: true, useBackendInference: true },
      WEIGHTS: { palm:0.8, saju:0.2, qualityImpact:0.35 },
      OVERLAY: { drawSpecialMarks:true, lineWidth:3 },
      SCIENTIFIC: { enableMedicalScreening: true, enableMLAnalysis: true, minConfidence: 0.65 }
    };

    const AppState = {
      currentStep: 1, currentAge: 0,
      palmImages: { left:null, right:null, quality:{left:null,right:null} },
      sajuData: { year:null, month:null, day:null, hour:null, gender:null, isLunar:false },
      analysisResults: null,
      banners:[],
      modalData: null
    };

    // Modal System
    function showScoreModal(scoreType) {
      const modal = document.getElementById('score-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      
      // Get score data
      const results = AppState.analysisResults;
      if (!results) return;
      
      const scores = results.scores;
      const palm = results.palmResults?.right || results.palmResults?.left || {};
      const aux = palm.auxiliaryLines || {};
      const mounts = palm.mounts || {};
      
      // Set title
      const titles = {
        wealth: '💰 재물운',
        career: '💼 직업운',
        love: '❤️ 애정운',
        health: '🏥 건강운',
        resilience: '💪 회복 탄력성',
        stressLoad: '😰 스트레스 부하'
      };
      
      title.innerHTML = `${titles[scoreType] || scoreType} 상세 분석`;
      
      // Generate content based on score type
      let content = '';
      
      if (scoreType === 'wealth') {
        const wealthLine = aux.wealthLine || {};
        const sunLine = aux.sunLine || {};
        
        content = `
          <div class="modal-section">
            <h3>📈 1. 분석 근거 (정량적 지표)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${wealthLine.strength || 75}%</div>
                <div class="metric-label">재물선 강도</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${sunLine.strength || 80}%</div>
                <div class="metric-label">태양선 강도</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${wealthLine.triangles || 1}개</div>
                <div class="metric-label">삼각 문양</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${scores.wealth.sajuContribution}%</div>
                <div class="metric-label">사주 기여도</div>
              </div>
            </div>
            <p style="margin-top:15px">
              <strong>구릉 영향:</strong> 태양구(Apollo) 발달도 ${mounts.sun?.development || 85}% - 명성과 부의 연관성<br>
              <strong>ATD 각도:</strong> ${palm.dermatoglyphics?.atdAngle || 41}° - 정상 범위
            </p>
          </div>
          
          <div class="modal-section">
            <h3>🔮 2. 상세 해석 (융합 결과)</h3>
            <p>현재 재물운 점수 <strong>${scores.wealth.score}점</strong>은 다음을 의미합니다:</p>
            <ul>
              <li>재물선의 ${wealthLine.clarity || 'deep'} 형태와 ${wealthLine.strength}% 강도는 안정적인 재물 축적 능력을 나타냅니다.</li>
              <li>태양선 ${sunLine.strength}% 발달은 명성을 통한 부의 창출 가능성을 시사합니다.</li>
              <li>${wealthLine.triangles > 0 ? `${wealthLine.triangles}개의 삼각 문양은 사업/투자 성공 신호입니다.` : '추가 재물 문양은 관찰되지 않았습니다.'}</li>
              <li>사주 ${scores.wealth.sajuContribution}% 보조로 ${AppState.currentAge + 5}세 경 재물 증가 기회가 예상됩니다.</li>
            </ul>
            ${scores.stressLoad > 70 ? `<p>⚠️ 높은 <span class="score-link" onclick="showScoreModal('stressLoad')">스트레스 부하(${scores.stressLoad}점)</span>가 재물운에 영향을 줄 수 있습니다.</p>` : ''}
          </div>
          
          <div class="modal-section">
            <h3>💡 3. 맞춤형 솔루션 (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">📊</span>
              <div>
                <strong>단기 전략 (3개월):</strong><br>
                현금흐름 최적화 - 수입의 ${Math.min(30, 10 + wealthLine.triangles * 5)}%를 투자 포트폴리오로 전환
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">💎</span>
              <div>
                <strong>중기 전략 (6개월):</strong><br>
                태양선 강도 ${sunLine.strength}%를 활용한 개인 브랜딩 강화 - SNS/포트폴리오 구축
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">🎯</span>
              <div>
                <strong>장기 전략 (1년):</strong><br>
                ${wealthLine.triangles > 0 ? '삼각 문양 신호에 따른 사업/부업 준비' : '안정적 자산 축적에 집중'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'career') {
        const fateLine = palm.fateLine || {};
        const sunLine = aux.sunLine || {};
        
        content = `
          <div class="modal-section">
            <h3>📈 1. 분석 근거 (정량적 지표)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${fateLine.strength || 72}%</div>
                <div class="metric-label">운명선 강도</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${sunLine.strength || 80}%</div>
                <div class="metric-label">태양선 강도</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${aux.risingLines?.count || 2}개</div>
                <div class="metric-label">향상선</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${mounts.jupiter?.development || 82}%</div>
                <div class="metric-label">목성구 발달</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>🔮 2. 상세 해석 (융합 결과)</h3>
            <p>현재 직업운 점수 <strong>${scores.career.score}점</strong>의 의미:</p>
            <ul>
              <li>운명선 ${fateLine.strength}% 발달로 직업적 안정성과 성장 가능성이 높습니다.</li>
              <li>목성구 ${mounts.jupiter?.development}% 발달은 리더십과 관리 능력을 나타냅니다.</li>
              <li>${aux.risingLines?.count || 0}개의 향상선은 승진/이직 기회를 시사합니다.</li>
            </ul>
          </div>
          
          <div class="modal-section">
            <h3>💡 3. 맞춤형 솔루션 (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">🎯</span>
              <div>
                <strong>경력 개발:</strong><br>
                목성구 발달도를 활용한 리더십 포지션 준비 - 팀 리더/매니저 역량 강화
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">📚</span>
              <div>
                <strong>스킬 향상:</strong><br>
                ${aux.risingLines?.count > 1 ? '향상선 신호에 따른 전문 자격증 취득' : '현 직무 전문성 심화'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'love') {
        const heartLine = palm.heartLine || {};
        const marriageLine = aux.marriageLine || {};
        
        content = `
          <div class="modal-section">
            <h3>📈 1. 분석 근거 (정량적 지표)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${heartLine.length || 82}%</div>
                <div class="metric-label">감정선 길이</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${marriageLine.count || 1}개</div>
                <div class="metric-label">결혼선</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${mounts.venus?.development || 80}%</div>
                <div class="metric-label">금성구 발달</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${heartLine.type || 'curved'}</div>
                <div class="metric-label">감정선 형태</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>🔮 2. 상세 해석 (융합 결과)</h3>
            <p>현재 애정운 점수 <strong>${scores.love.score}점</strong>의 의미:</p>
            <ul>
              <li>감정선 ${heartLine.type === 'curved' ? '곡선형' : '직선형'}은 ${heartLine.type === 'curved' ? '감성적이고 열정적인' : '이성적이고 안정적인'} 연애 스타일을 나타냅니다.</li>
              <li>금성구 ${mounts.venus?.development}% 발달은 매력과 애정 표현력을 보여줍니다.</li>
              <li>${marriageLine.count}개의 결혼선은 ${marriageLine.count === 1 ? '안정적인 관계' : '다양한 인연'}을 암시합니다.</li>
            </ul>
          </div>
          
          <div class="modal-section">
            <h3>💡 3. 맞춤형 솔루션 (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">💕</span>
              <div>
                <strong>관계 개선:</strong><br>
                ${heartLine.type === 'curved' ? '감정 표현 조절과 안정성 확보' : '감성적 표현력 향상 연습'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'health') {
        const lifeLine = palm.lifeLine || {};
        const healthLine = aux.healthLine || {};
        
        content = `
          <div class="modal-section">
            <h3>📈 1. 분석 근거 (정량적 지표)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${lifeLine.length || 84}%</div>
                <div class="metric-label">생명선 길이</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${lifeLine.depth || 'deep'}</div>
                <div class="metric-label">생명선 깊이</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${scores.resilience.score}점</div>
                <div class="metric-label">회복 탄력성</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${scores.stressLoad.score}점</div>
                <div class="metric-label">스트레스 부하</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>🔮 2. 상세 해석 (융합 결과)</h3>
            <p>현재 건강운 점수 <strong>${scores.health.score}점</strong>의 의미:</p>
            <ul>
              <li>생명선 ${lifeLine.length}% 길이와 ${lifeLine.depth} 깊이는 전반적으로 양호한 체력을 나타냅니다.</li>
              <li><span class="score-link" onclick="showScoreModal('resilience')">회복 탄력성 ${scores.resilience.score}점</span>은 ${scores.resilience.score > 70 ? '빠른 회복력' : '회복력 강화 필요'}을 의미합니다.</li>
              <li><span class="score-link" onclick="showScoreModal('stressLoad')">스트레스 부하 ${scores.stressLoad.score}점</span>은 ${scores.stressLoad.score > 70 ? '즉각적인 스트레스 관리 필요' : '적정 수준'}입니다.</li>
            </ul>
          </div>
          
          <div class="modal-section">
            <h3>💡 3. 맞춤형 솔루션 (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">🏃</span>
              <div>
                <strong>운동 계획:</strong><br>
                회복 탄력성 ${scores.resilience.score}점 기준 → ${scores.resilience.score > 70 ? '고강도 인터벌 운동 가능' : '저강도 유산소 운동 권장'}
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">🧘</span>
              <div>
                <strong>스트레스 관리:</strong><br>
                ${scores.stressLoad.score > 70 ? '즉시 명상/호흡법 도입, 주 3회 이상' : '예방적 스트레스 관리 유지'}
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'resilience') {
        const lifeLine = palm.lifeLine || {};
        const marsLower = mounts.mars_lower?.development || 0;
        const marsUpper = mounts.mars_upper?.development || 0;
        
        content = `
          <div class="modal-section">
            <h3>📈 1. 분석 근거 (정량적 지표)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${lifeLine.length || 84}%</div>
                <div class="metric-label">생명선 길이</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${Math.max(marsLower, marsUpper)}%</div>
                <div class="metric-label">화성구 발달</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${aux.healthLine?.breaks ? '있음' : '없음'}</div>
                <div class="metric-label">건강선 단절</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>🔮 2. 상세 해석 (융합 결과)</h3>
            <p>현재 회복 탄력성 점수 <strong>${scores.resilience.score}점</strong>의 의미:</p>
            <ul>
              <li>생명선 길이 ${lifeLine.length}%는 기본 체력과 회복력의 기반을 나타냅니다.</li>
              <li>화성구 발달도 ${Math.max(marsLower, marsUpper)}%는 신체적 활력과 저항력을 보여줍니다.</li>
              <li>${aux.healthLine?.breaks ? '건강선 단절은 회복 과정에서 주의가 필요함을 시사합니다.' : '건강선 연속성은 안정적인 회복력을 지원합니다.'}</li>
            </ul>
            <p>연관 지표: <span class="score-link" onclick="showScoreModal('health')">건강운 ${scores.health.score}점</span></p>
          </div>
          
          <div class="modal-section">
            <h3>💡 3. 맞춤형 솔루션 (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">💪</span>
              <div>
                <strong>체력 증진:</strong><br>
                화성구 ${Math.max(marsLower, marsUpper)}% 수준 → ${Math.max(marsLower, marsUpper) > 70 ? '근력 운동 강화' : '기초 체력 구축 우선'}
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">🛌</span>
              <div>
                <strong>회복 최적화:</strong><br>
                수면 시간 ${scores.resilience.score > 70 ? '7시간' : '8시간'} 확보, 회복 보조제 고려
              </div>
            </div>
          </div>
        `;
      }
      else if (scoreType === 'stressLoad') {
        const interferingLines = aux.interferingLines || {};
        
        content = `
          <div class="modal-section">
            <h3>📈 1. 분석 근거 (정량적 지표)</h3>
            <div class="metric-grid">
              <div class="metric-box">
                <div class="metric-value">${interferingLines.visible ? '있음' : '없음'}</div>
                <div class="metric-label">간섭선</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${interferingLines.count || 0}개</div>
                <div class="metric-label">간섭선 수</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${lifeLine.breaks || 0}개</div>
                <div class="metric-label">생명선 단절</div>
              </div>
              <div class="metric-box">
                <div class="metric-value">${palm.mountColors?.venus === '#ff9999' ? '붉음' : '정상'}</div>
                <div class="metric-label">구릉 색조</div>
              </div>
            </div>
          </div>
          
          <div class="modal-section">
            <h3>🔮 2. 상세 해석 (융합 결과)</h3>
            <p>현재 스트레스 부하 점수 <strong>${scores.stressLoad.score}점</strong>의 의미:</p>
            <ul>
              <li>${interferingLines.visible ? `${interferingLines.count}개의 간섭선은 현재 스트레스 요인이 활성화되어 있음을 나타냅니다.` : '간섭선이 없어 스트레스 수준이 양호합니다.'}</li>
              <li>${lifeLine.breaks > 0 ? '생명선 단절은 스트레스로 인한 에너지 소모를 시사합니다.' : '생명선이 연속적이어서 스트레스 대처력이 안정적입니다.'}</li>
            </ul>
            <p>연관 지표: <span class="score-link" onclick="showScoreModal('resilience')">회복 탄력성 ${scores.resilience.score}점</span>, <span class="score-link" onclick="showScoreModal('health')">건강운 ${scores.health.score}점</span></p>
          </div>
          
          <div class="modal-section">
            <h3>💡 3. 맞춤형 솔루션 (Action Plan)</h3>
            <div class="action-item">
              <span class="action-icon">🧘</span>
              <div>
                <strong>즉시 실행:</strong><br>
                ${scores.stressLoad.score > 70 ? '하루 3회 심호흡(4-7-8 호흡법), 주 3회 명상 앱 사용' : '예방적 스트레스 관리 유지'}
              </div>
            </div>
            <div class="action-item">
              <span class="action-icon">📝</span>
              <div>
                <strong>스트레스 원인 관리:</strong><br>
                ${interferingLines.count > 1 ? '다중 스트레스 원인 → 우선순위 설정 후 단계적 해결' : '단일 스트레스 원인 집중 해결'}
              </div>
            </div>
          </div>
        `;
      }
      
      body.innerHTML = DOMPurify.sanitize(content);
      modal.classList.add('active');
    }

    function closeModal() {
      document.getElementById('score-modal').classList.remove('active');
    }

    // Close modal on outside click
    document.getElementById('score-modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // UTILS
    async function fetchWithTimeout(resource, options={}, timeout=15000){
      const controller = new AbortController(); const id=setTimeout(()=>controller.abort(), timeout);
      try{
        const res=await fetch(resource,{...options,signal:controller.signal});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const ct=res.headers.get("content-type")||"";
        return ct.includes("application/json")?await res.json():await res.text();
      } finally{ clearTimeout(id); }
    }

    function cap01(x){ return Math.max(0,Math.min(1,x)); }
    function avgQuality01(){ const l=AppState.palmImages.quality.left?.score, r=AppState.palmImages.quality.right?.score; const arr=[l,r].filter(v=>typeof v==='number'); return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length/100:0.5; }

    // Image Quality Evaluation
    async function evaluateImageQuality(dataUrl){
      const img=await new Promise((res)=>{ const i=new Image(); i.onload=()=>res(i); i.src=dataUrl; });
      const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
      canvas.width=256; canvas.height=256; ctx.drawImage(img,0,0,256,256);
      const data=ctx.getImageData(0,0,256,256).data;
      
      let brightness=0; for(let i=0;i<data.length;i+=4){ brightness+=0.34*data[i]+0.5*data[i+1]+0.16*data[i+2]; }
      brightness=brightness/(256*256);
      
      const score=Math.round(70+(brightness-128)*0.3+Math.random()*10);
      return {score:Math.max(30,Math.min(95,score)), brightness:Math.round(brightness)};
    }

    // Hand Shape Classification
    async function classifyHandShapeHeuristic(dataUrl, quality){
      const img = await new Promise((res)=>{ const i=new Image(); i.onload=()=>res(i); i.src=dataUrl; });
      const ar = img.height / img.width;
      const edge = quality?.edgeDensity ?? 0.12;
      let type='Air';
      if(ar>1.2 && edge<0.15) type='Water';
      else if(Math.abs(ar-1.0)<0.15 && edge>=0.1) type='Earth';
      else if(edge>0.18) type='Fire';
      const elem = {Fire:'火',Earth:'土',Air:'風',Water:'水'}[type]||'風';
      const weights = {
        Fire:  {career:+4, wealth:+2, love:+3, health:-1},
        Earth: {career:+2, wealth:+3, love:+1, health:+3},
        Air:   {career:+3, wealth:+2, love:+2, health:+1},
        Water: {career:+1, wealth:+1, love:+3, health:-1}
      }[type]||{career:0,wealth:0,love:0,health:0};
      return {type, element:elem, weights};
    }

    // Scientific Scores
    function computeResilienceScore(palm){
      const ll = palm?.lifeLine?.length ?? 70;
      const marsDev = Math.max(palm?.mounts?.mars_lower?.development||0, palm?.mounts?.mars_upper?.development||0);
      let score = 40 + (ll-70)*0.4 + (marsDev-60)*0.2;
      if(palm?.auxiliaryLines?.healthLine?.breaks) score -= 10;
      return Math.max(0,Math.min(100,Math.round(score)));
    }

    function computeStressLoadScore(palm){
      let s = 50;
      const inter = palm?.auxiliaryLines?.interferingLines;
      if(inter?.visible) s += 8 + (inter.count||1)*2;
      if(palm?.lifeLine?.breaks) s += 8;
      return Math.max(0,Math.min(100,Math.round(s)));
    }

    // Stub Analysis
    class SajuCalculator {
      async calculate(y,m,d,h,g,isLunar){
        return {degraded:true, pillars:null, pattern:null, fiveElements:{'木':20,'火':25,'土':18,'金':20,'水':17}};
      }
    }

    class InferenceClient {
      static async run(dataUrl, progress){
        return {
          handShape: {type:'Fire', element:'火', weights:{career:+4, wealth:+2, love:+3, health:-1}},
          lifeLine:{length:85, breaks:0, type:'curved', depth:'deep'},
          headLine:{length:78, type:'straight'},
          heartLine:{length:82, type:'curved'},
          fateLine:{visible:true, strength:72},
          auxiliaryLines:{
            sunLine:{visible:true, strength:80, contribution:25},
            wealthLine:{visible:true, strength:78, triangles:2, clarity:'deep', contribution:30},
            interferingLines:{visible:true, count:1, contribution:-8},
            marriageLine:{visible:true, count:1, clarity:'clear'},
            healthLine:{visible:true, breaks:0},
            risingLines:{count:2}
          },
          mounts:{jupiter:{development:82}, saturn:{development:70}, sun:{development:88}, mercury:{development:75}, venus:{development:80}, moon:{development:74}, mars_lower:{development:78}, mars_upper:{development:70}},
          mountColors:{venus:'#ffcccc'},
          dermatoglyphics:{atdAngle:41},
          accuracy:0.92
        };
      }
    }

    // Analyzer
    class AdvancedPalmAnalyzer{
      async analyzePalm(imageData, progress){
        const api = await InferenceClient.run(imageData, progress);
        return api;
      }
    }

    // Scoring
    function calculateScoresV3(palmResults, sajuResults, handShape){
      const palm = palmResults.left || palmResults.right;
      const aux = palm?.auxiliaryLines || {};
      
      let wealth=50, career=50, health=50, love=50;
      
      if(handShape?.weights){
        career += handShape.weights.career;
        wealth += handShape.weights.wealth;
        love += handShape.weights.love;
        health += handShape.weights.health;
      }
      
      if(palm?.fateLine?.visible) career += (palm.fateLine.strength||60)*0.35;
      if(palm?.lifeLine) health += (palm.lifeLine.length||70)*0.30;
      if(palm?.heartLine) love += (palm.heartLine.length||70)*0.28;
      if(aux?.sunLine?.visible) career += (aux.sunLine.contribution ?? 20);
      if(aux?.wealthLine?.visible) wealth += (aux.wealthLine.contribution ?? 25);
      if(aux?.marriageLine?.visible) love += 6;
      if(aux?.healthLine?.visible) health += aux.healthLine.breaks? -6 : +3;
      if(aux?.risingLines?.count) career += Math.min(8, aux.risingLines.count*3);
      if(aux?.interferingLines?.visible){ wealth -= 8; career -= 8; }
      
      const resilience = computeResilienceScore(palm);
      const stressLoad = computeStressLoadScore(palm);
      
      const cap=v=>Math.max(0,Math.min(100,Math.round(v)));
      wealth=cap(wealth); career=cap(career); health=cap(health); love=cap(love);
      const total = Math.round((wealth+career+health+love)/4);
      
      return {
        total, confidence:85,
        wealth:{score:wealth, palmContribution:80, sajuContribution:20},
        career:{score:career, palmContribution:80, sajuContribution:20},
        health:{score:health, palmContribution:80, sajuContribution:20},
        love:{score:love, palmContribution:80, sajuContribution:20},
        resilience:{score:resilience}, 
        stressLoad:{score:stressLoad}
      };
    }

    // Integration
    class IntegratedAnalysisEngine{
      constructor(){
        this.palmAnalyzer = new AdvancedPalmAnalyzer();
        this.sajuCalc = new SajuCalculator();
      }
      
      async analyze(palmImages, sajuData, progress){
        progress?.(10,'손금 분석...');
        const palms = {};
        if(palmImages.left) palms.left = await this.palmAnalyzer.analyzePalm(palmImages.left);
        if(palmImages.right) palms.right = await this.palmAnalyzer.analyzePalm(palmImages.right);
        
        const palm = palms.right || palms.left;
        const handShape = await classifyHandShapeHeuristic(palmImages.right || palmImages.left, AppState.palmImages.quality.right || AppState.palmImages.quality.left);
        
        progress?.(62,'사주 보조 분석...');
        const saju = await this.sajuCalc.calculate(sajuData.year, sajuData.month, sajuData.day, sajuData.hour, sajuData.gender, sajuData.isLunar);
        
        progress?.(82,'통합 스코어링...');
        const scores = calculateScoresV3(palms, saju, handShape);
        
        progress?.(100,'완료');
        return {scores, palmResults:palms, sajuResults:saju, handShape};
      }
    }

    // UI Functions
    function updateStepUI(){
      document.querySelectorAll('.step-content').forEach(s=>s.classList.remove('active'));
      document.getElementById(`step${AppState.currentStep}`).classList.add('active');
      document.querySelectorAll('.step').forEach((s,i)=>{
        s.classList.remove('active','completed');
        if(i+1===AppState.currentStep) s.classList.add('active');
        else if(i+1<AppState.currentStep) s.classList.add('completed');
      });
      document.querySelector('.progress-fill').style.width = `${(AppState.currentStep/4)*100}%`;
    }

    function nextStep(){
      if(AppState.currentStep===1){
        if(!AppState.palmImages.left && !AppState.palmImages.right){ alert('최소 한 손의 사진을 업로드해주세요.'); return; }
      }else if(AppState.currentStep===2){
        if(!validateSajuForm()) return; 
        saveSajuData();
      }
      if(AppState.currentStep<4){ AppState.currentStep++; updateStepUI(); }
    }

    function previousStep(){ if(AppState.currentStep>1){ AppState.currentStep--; updateStepUI(); } }

    function validateSajuForm(){
      const get=(id)=>document.getElementById(id);
      const y=+get('birth-year').value, m=+get('birth-month').value, d=+get('birth-day').value;
      const g=get('gender').value;
      let ok=true;
      if(!y||y<1900||y>2100) ok=false;
      if(!m||m<1||m>12) ok=false;
      if(!d||d<1||d>31) ok=false;
      if(!g) ok=false;
      return ok;
    }

    function saveSajuData(){
      const get=(id)=>document.getElementById(id);
      AppState.sajuData = {
        year:+get('birth-year').value,
        month:+get('birth-month').value,
        day:+get('birth-day').value,
        hour:+get('birth-hour').value,
        gender:get('gender').value,
        isLunar:get('lunar-calendar').checked
      };
      const today=new Date();
      const birth=new Date(AppState.sajuData.year, AppState.sajuData.month-1, AppState.sajuData.day);
      AppState.currentAge = today.getFullYear()-birth.getFullYear();
    }

    // Image Upload
    async function handleImageUpload(file, hand){
      if(!file) return;
      const reader=new FileReader();
      reader.onload=async e=>{
        const data=e.target.result;
        const q = await evaluateImageQuality(data);
        AppState.palmImages[hand]=data;
        AppState.palmImages.quality[hand]=q;
        updateImagePreview(hand, data, q);
      };
      reader.readAsDataURL(file);
    }

    function updateImagePreview(hand, dataUrl, quality){
      const preview=document.getElementById(`${hand}-preview`);
      const badge=document.getElementById(`${hand}-quality`);
      const card=document.getElementById(`${hand}-upload`);
      preview.src=dataUrl; preview.classList.add('visible'); card.classList.add('has-image');
      let cls='quality-low', txt='낮음';
      if(quality.score>=82){ cls='quality-high'; txt='높음'; } 
      else if(quality.score>=70){ cls='quality-medium'; txt='보통'; }
      badge.className=`quality-badge ${cls}`; 
      badge.textContent=`품질: ${txt} (${quality.score}/100)`;
    }

    // Analysis
    async function startAnalysis(){
      if(!(AppState.palmImages.left||AppState.palmImages.right)) return;
      document.getElementById('loading').classList.add('active');
      
      try{
        const engine = new IntegratedAnalysisEngine();
        const progress=(p,msg)=>{
          document.getElementById('loading-percentage').textContent=`${Math.round(p)}%`;
          document.getElementById('loading-text').textContent=msg||'분석 중...';
          document.getElementById('loading-progress-bar').style.width=`${p}%`;
        };
        
        const res = await engine.analyze(AppState.palmImages, AppState.sajuData, progress);
        AppState.analysisResults = res;
        AppState.currentStep = 4;
        updateStepUI();
        renderResults(res);
      }catch(err){
        console.error(err);
        alert('분석 중 오류가 발생했습니다.');
      }finally{
        document.getElementById('loading').classList.remove('active');
      }
    }

    function cancelAnalysis(){ document.getElementById('loading').classList.remove('active'); }

    // Render Results with Clickable Cards
    function renderResults(r){
      const grid=document.getElementById('result-grid');
      const detail=document.getElementById('detailed-result');
      const W=r.scores.wealth, C=r.scores.career, L=r.scores.love, H=r.scores.health;
      
      grid.innerHTML=`
        <div class="result-card"><div class="result-score">${r.scores.total}</div><div class="result-sub">종합 점수</div></div>
        <div class="result-card clickable" onclick="showScoreModal('wealth')"><div class="result-score">${W.score}</div><div class="result-sub">재물운 · ${W.palmContribution}/${W.sajuContribution}%</div></div>
        <div class="result-card clickable" onclick="showScoreModal('career')"><div class="result-score">${C.score}</div><div class="result-sub">직업운 · ${C.palmContribution}/${C.sajuContribution}%</div></div>
        <div class="result-card clickable" onclick="showScoreModal('love')"><div class="result-score">${L.score}</div><div class="result-sub">애정운 · ${L.palmContribution}/${L.sajuContribution}%</div></div>
        <div class="result-card clickable" onclick="showScoreModal('health')"><div class="result-score">${H.score}</div><div class="result-sub">건강운</div></div>
        <div class="result-card clickable" onclick="showScoreModal('resilience')"><div class="result-score">${r.scores.resilience?.score ?? '-'}</div><div class="result-sub">회복 탄력성</div></div>
        <div class="result-card clickable" onclick="showScoreModal('stressLoad')"><div class="result-score">${r.scores.stressLoad?.score ?? '-'}</div><div class="result-sub">스트레스 부하</div></div>
        <div class="result-card"><div class="result-score">${r.scores.confidence||80}%</div><div class="result-sub">신뢰도</div></div>
      `;
      
      detail.innerHTML = `
        <div class="expert-card">
          <h3>📊 분석 개요</h3>
          <p><strong>현재 나이:</strong> ${AppState.currentAge}세</p>
          <p><strong>손 형태:</strong> ${r.handShape?.type} (${r.handShape?.element})</p>
          <p style="margin-top:12px;color:#666">💡 스코어 카드를 클릭하면 상세 분석을 볼 수 있습니다.</p>
        </div>
      `;
    }

    // Export Functions
    function exportResults(){ window.print(); }
    function exportCSV(){ 
      const r=AppState.analysisResults; 
      if(!r) return;
      const rows=[['항목','점수'],['종합',r.scores.total],['재물',r.scores.wealth.score],['직업',r.scores.career.score],['애정',r.scores.love.score],['건강',r.scores.health.score],['회복탄력성',r.scores.resilience.score],['스트레스부하',r.scores.stressLoad.score]];
      const csv=rows.map(r=>r.join(',')).join('\n');
      const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); 
      a.href=URL.createObjectURL(blob); 
      a.download='PalmAI_Results.csv'; 
      a.click();
    }
    function exportToSheets(){ exportCSV(); alert('CSV 파일을 Google Sheets에서 열어주세요.'); }

    // UI Handlers
    function openGuide(){ document.getElementById('guide').classList.add('active'); }
    function closeGuide(){ document.getElementById('guide').classList.remove('active'); }
    function showPrivacyInfo(){ document.getElementById('privacy-modal').classList.add('active'); }
    function closePrivacyModal(){ document.getElementById('privacy-modal').classList.remove('active'); }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.step').forEach(s=>{ s.addEventListener('click',()=>{ const n=+s.dataset.step; if(n<=AppState.currentStep){ AppState.currentStep=n; updateStepUI(); } }); });
      document.getElementById('left-upload').addEventListener('click',()=>document.getElementById('left-hand-input').click());
      document.getElementById('right-upload').addEventListener('click',()=>document.getElementById('right-hand-input').click());
      document.getElementById('left-hand-input').addEventListener('change',e=>handleImageUpload(e.target.files[0],'left'));
      document.getElementById('right-hand-input').addEventListener('change',e=>handleImageUpload(e.target.files[0],'right'));
    });
  </script>
</body>
</html>